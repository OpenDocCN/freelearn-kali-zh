# 评估身份验证方案

在本章中，我们将涵盖以下示例：

+   测试帐户枚举和可猜测的帐户

+   测试弱锁定机制

+   测试绕过身份验证方案

+   测试浏览器缓存弱点

+   通过 REST API 测试帐户配置过程

# 介绍

本章涵盖了对身份验证方案的基本渗透测试。*身份验证*是验证个人或对象声明是否真实的行为。Web 渗透测试人员必须进行关键评估，以确定目标应用程序的身份验证方案的强度。此类测试包括发动攻击，以确定帐户枚举和可猜测的帐户的存在，弱锁定机制的存在，应用程序方案是否可以被绕过，应用程序是否包含浏览器缓存弱点，以及是否可以通过 REST API 调用进行身份验证来配置帐户。您将学习如何使用 Burp 执行此类测试。

# 软件工具要求

要完成本章的示例，您需要以下内容：

+   OWASP Broken Web Applications（VM）

+   OWASP Mutillidae 链接

+   GetBoo 链接

+   Burp 代理社区或专业版（[`portswigger.net/burp/`](https://portswigger.net/burp/)）

+   配置为允许 Burp 代理流量的 Firefox 浏览器（[`www.mozilla.org/en-US/firefox/new/`](https://www.mozilla.org/en-US/firefox/new/)）

# 测试帐户枚举和可猜测的帐户

通过与身份验证机制进行交互，测试人员可能会发现可以收集一组有效的用户名。一旦识别出有效帐户，就可能有可能对密码进行暴力破解。本示例解释了如何使用 Burp Intruder 来收集有效用户名列表。

# 做好准备

针对目标应用程序执行用户名枚举。

# 如何做...

确保 Burp 和 OWASP BWA VM 正在运行，并且 Burp 已在用于查看 OWASP BWA 应用程序的 Firefox 浏览器中进行配置。

1.  从 OWASP BWA 登陆页面，单击 GetBoo 应用程序的链接：

![](img/00135.jpeg)

1.  单击**登录**按钮，在登录屏幕上，尝试使用帐户用户名`admin`和密码`aaaaa`登录：

![](img/00136.jpeg)

1.  注意返回的消息是**密码无效**。根据这个信息，我们知道 admin 是一个有效的帐户。让我们使用 Burp **入侵者**来查找更多帐户。

1.  在 Burp 的**代理**|**HTTP 历史**选项卡中，找到登录失败的消息。查看**响应**|**原始**选项卡，找到相同的过于冗长的错误消息，**密码无效**：

![](img/00137.jpeg)

1.  切换回**请求**|**原始**选项卡，右键单击将此请求发送到**入侵者**：

![](img/00138.jpeg)

1.  转到 Burp 的**入侵者**选项卡，将**入侵者**|**目标**选项卡设置保持不变。继续到**入侵者**|**位置**选项卡。注意 Burp 如何在找到的每个参数值周围放置有效载荷标记。但是，我们只需要在密码值周围放置有效载荷标记。单击**清除**按钮以删除 Burp 放置的有效载荷标记：

![](img/00139.jpeg)

1.  然后，使用光标突出显示 admin 的名称值，并单击**添加§**按钮：

![](img/00140.jpeg)

1.  继续到**入侵者**|**有效载荷**选项卡。许多测试人员使用单词列表来枚举有效载荷标记占位符中常用的用户名。对于这个示例，我们将输入一些常见的用户名，以创建自定义有效载荷列表。

1.  在**有效载荷选项[简单列表]**部分，键入字符串`user`，然后单击**添加**按钮：

![](img/00141.jpeg)

1.  在有效载荷列表框中添加一些字符串，如`john`，`tom`，`demo`，最后是`admin`：

![](img/00142.jpeg)

1.  转到**入侵者**|**选项**选项卡，向下滚动到**Grep - 匹配**部分。单击复选框**标记结果**，**与这些表达式匹配的响应项**。单击**清除**按钮以删除当前列表中的项目：

![](img/00143.jpeg)

1.  单击**是**以确认您希望清除列表。

1.  在文本框中输入字符串`密码无效`，然后单击**Add**按钮。您的**Grep - Match**部分应如下截图所示：

![](img/00144.jpeg)

1.  单击**Options**页面顶部的**Start attack**按钮。弹出对话框显示定义的有效负载，以及我们在**Grep - Match**部分下添加的新列。这个弹出窗口是攻击结果表。

1.  攻击结果表显示每个请求的给定有效负载导致状态代码为**200**，其中两个有效负载**john**和**tom**在响应中没有产生**密码无效**的消息。相反，这两个有效负载返回了**用户不存在**的消息：

![](img/00145.jpeg)

1.  这次攻击的结果表明，基于过于冗长的错误消息**密码无效**，存在用户名枚举漏洞，这证实了用户帐户存在于系统中：

![](img/00146.jpeg)

这意味着我们能够确认系统中已经存在用户`user`，`demo`和`admin`的帐户。

# 测试弱锁定机制

应用程序应该设置锁定机制以减轻暴力登录攻击。通常，应用程序在三到五次尝试之间设置阈值。许多应用程序在允许重新尝试之前会锁定一段时间。

渗透测试人员必须测试登录保护的所有方面，包括挑战问题和响应（如果存在）。

# 做好准备

确定应用程序是否存在适当的锁定机制。如果不存在，尝试针对登录页面的凭据进行暴力破解，以实现对应用程序的未经授权访问。使用 OWASP Mutillidae II 应用程序，尝试使用有效用户名但无效密码登录五次。

# 如何操作...

确保 Burp 和 OWASP BWA VM 正在运行，并且 Burp 已在用于查看 OWASP BWA 应用程序的 Firefox 浏览器中进行配置。

1.  从 OWASP BWA 登陆页面，单击链接到 OWASP Mutillidae II 应用程序。

1.  打开 Firefox 浏览器，转到 OWASP Mutillidae II 的登录屏幕。从顶部菜单中，单击**登录**。

1.  在登录屏幕上，尝试使用用户名`admin`和错误密码`aaaaaa`登录五次。请注意，在这五次尝试期间，应用程序没有做出任何不同的反应。应用程序没有更改显示的错误消息，管理员帐户也没有被锁定。这意味着登录可能容易受到暴力破解密码猜测攻击的影响：

![](img/00147.jpeg)

让我们继续测试，以暴力破解登录页面并未经授权地访问应用程序。

1.  转到**Proxy** | **HTTP history**选项卡，并查找登录失败的尝试。右键单击五个请求中的一个，并将其发送到**Intruder**：

![](img/00148.jpeg)

1.  转到 Burp 的**Intruder**选项卡，并将**Intruder** | **Target**选项卡设置保持不变。继续到**Intruder** | **Positions**选项卡，并注意 Burp 如何在找到的每个参数值周围放置有效负载标记。但是，我们只需要在密码的值周围放置有效负载标记。单击**Clear §**按钮以删除 Burp 放置的有效负载标记：

![](img/00149.jpeg)

1.  然后，突出显示**aaaaaa**的密码值，然后单击**Add §**按钮。

1.  继续到**Intruder** | **Payloads**选项卡。许多测试人员使用单词列表来暴力破解有效负载标记占位符中常用的密码。对于这个示例，我们将输入一些常用密码来创建我们自己的独特有效负载列表。

1.  在**Payload Options [Simple list]**部分，输入字符串`admin123`，然后单击**Add**按钮：

![](img/00150.jpeg)

1.  在有效负载列表框中添加一些字符串，例如`adminpass`，`welcome1`，最后是`admin`：

![](img/00151.jpeg)

1.  转到**Intruder** | **Options**选项卡，向下滚动到**Grep – Extract**部分：

![](img/00152.jpeg)

1.  点击复选框**Extract the following items from responses**，然后点击**Add**按钮。一个弹出框会显示，显示你使用`admin`/`aaaaaa`请求进行的登录尝试的响应。

1.  在底部的搜索框中搜索`Not Logged In`这几个单词。找到匹配后，你必须正确地突出显示**Not Logged In**这几个单词，以正确地分配 grep 匹配：

![](img/00153.jpeg)

1.  如果你没有正确地突出显示单词，在点击**确定**后，你会在**Grep – Extract**框内看到**[INVALID]**。如果发生这种情况，点击**删除**按钮删除条目，然后再次点击**添加**按钮，执行搜索，突出显示单词。

1.  如果你正确地突出显示了单词，你应该在**Grep – Extract**框中看到以下内容：

![](img/00154.jpeg)

1.  现在，在**Options**页面的右上角点击**Start attack**按钮。

1.  弹出的攻击结果表格会显示请求和你定义的有效负载放置到有效负载标记位置中。注意到产生的攻击表格显示了一个名为**ReflectedXSSExecution**的额外列。这一列是之前设置的**Grep – Extract Option**的结果。

1.  从这个攻击表格中，查看额外的列，测试人员可以轻松地确定哪个请求号成功地暴力破解了登录界面。在这种情况下，**Request 4**，使用用户名`admin`和密码`admin`成功地登录了应用程序：

![](img/00155.jpeg)

1.  在攻击表格中选择**Request 4**，查看**Response** | **Render**选项卡。你应该在右上角看到消息**Logged In Admin: admin (g0t r00t?)**：

![](img/00156.jpeg)

1.  点击攻击表格右上角的**X**关闭攻击表格。

你成功地暴力破解了系统上一个有效账户的密码，因为应用程序的锁定机制较弱。

# 测试绕过身份验证方案

应用程序可能存在缺陷，允许绕过已经存在的身份验证措施进行未经授权的访问。绕过技术包括**直接页面请求**（即强制浏览）、**参数修改**、**会话 ID 预测**和**SQL 注入**。

为了本教程的目的，我们将使用参数修改。

# 准备工作

添加和编辑参数，使未经身份验证的请求与先前捕获的经过身份验证的请求匹配。重放修改后的未经身份验证的请求，以绕过登录机制获取对应用程序的访问权限。

# 操作步骤

1.  打开 Firefox 浏览器，使用顶部菜单左侧的**Home**按钮，打开 OWASP Mutillidae II 的主页。确保你*没有登录*该应用程序。如果你已经登录，从菜单中选择**Logout**：

![](img/00157.jpeg)

1.  在 Burp 中，转到**Proxy** | **HTTP history**选项卡，并选择刚刚进行的未经身份验证的主页浏览请求。右键单击，然后选择**Send to Repeater**：

![](img/00158.jpeg)

1.  使用相同的请求和位置，再次右键单击，然后选择**Send to Comparer**（请求）：

![](img/00159.jpeg)

1.  返回浏览器的主页，然后点击**登录/注册**按钮。在登录页面，使用用户名`admin`和密码`admin`进行登录。点击**登录**。

1.  登录后，继续注销。确保你按下**注销**按钮并从管理员账户注销。

1.  在 Burp 中，转到**Proxy** | **HTTP history**选项卡，并选择刚刚进行的请求，以`admin`身份登录。选择`POST 302`重定向后立即进行的`GET`请求。右键单击，然后选择**Send to** **Repeater**（请求）：

![](img/00160.jpeg)

1.  使用相同的请求和位置，再次右键单击并选择**Send to Comparer**（请求）：

![](img/00161.jpeg)

1.  转到 Burp 的**Comparer**选项卡。注意您发送的两个请求都被突出显示。按下右下角的**Words**按钮，同时比较这两个请求：

![](img/00162.jpeg)

1.  一个对话框弹出显示两个请求，使用颜色编码的高亮显示来吸引您的注意。注意**Referer**标头中的更改以及放置在管理员帐户 cookie 中的附加名称/值对。使用右侧的**X**关闭弹出框：

![](img/00163.jpeg)

1.  返回到**Repeater**，其中包含您作为未经身份验证的用户执行的第一个`GET`请求。在执行此攻击之前，请确保您已完全注销应用程序。

1.  您可以通过单击与您未经身份验证请求相关的**Repeater**中的**Go**按钮来验证您已注销：

![](img/00164.jpeg)

1.  现在切换到**Repeater**选项卡，其中包含您作为经过身份验证的用户`admin`执行的第二个`GET`请求。从经过身份验证的请求中复制**Referer**标头和**Cookie**的值。这是用于绕过身份验证的参数修改攻击：

![](img/00165.jpeg)

1.  从经过身份验证的`GET`请求中复制突出显示的标头（**Referer 和 Cookie**）。您将把这些值粘贴到未经身份验证的`GET`请求中。

1.  通过突出显示并右键单击，然后选择**粘贴**，在未经身份验证的`GET`请求中替换相同的标头。

1.  右键单击并选择**粘贴**在您作为未经身份验证的用户执行的第一个`GET`请求的**Repeater** | **Raw**选项卡中。

1.  单击**Go**按钮发送您修改后的`GET`请求。请记住，这是您作为未经身份验证的用户执行的第一个`GET`请求。

1.  验证您现在在**Response** | **Render**选项卡中以管理员身份登录。我们能够通过执行参数操作绕过身份验证机制（即登录页面）：

![](img/00166.jpeg)

# 工作原理

通过将 cookie 中找到的令牌和经过身份验证的请求的 referer 值重新播放到未经身份验证的请求中，我们能够绕过身份验证方案并未经授权地访问应用程序。

# 测试浏览器缓存的弱点

浏览器缓存可提供改进的性能和更好的最终用户体验。但是，当用户在浏览器中输入敏感数据时，这些数据也可能被缓存在浏览器历史记录中。通过检查浏览器的缓存或简单地按下浏览器的*返回*按钮，可以查看这些缓存数据。

# 准备就绪

使用浏览器的返回按钮，确定登录凭据是否被缓存，从而允许未经授权的访问。在 Burp 中检查这些步骤，以了解漏洞。

# 如何操作...

1.  以`admin`身份使用密码`admin`登录 Mutillidae 应用程序。

1.  现在通过单击顶部菜单中的**注销**按钮注销应用程序。

1.  通过注意**未登录**消息来验证您已注销。

1.  在 Burp 的**Proxy** | **History**中查看这些步骤作为消息。请注意，注销会执行**302**重定向，以防止在浏览器中缓存 cookie 或凭据：

![](img/00167.jpeg)

1.  从 Firefox 浏览器，单击返回按钮，注意即使您没有登录，您现在已经以管理员身份登录！这是因为浏览器中存储的缓存凭据以及应用程序中未设置任何缓存控制保护。

1.  现在在浏览器中刷新/重新加载页面，您会看到您再次被注销。

1.  在**Proxy** | **HTTP history**选项卡中检查这些步骤。通过浏览器执行的步骤与**Proxy** | **HTTP history**表中捕获的消息进行对比：

+   以下截图中的请求 1 是未经身份验证的

+   请求 35 是成功登录（302）为`admin`

+   请求 37 是`admin`帐户的注销

+   请求 38 和 39 是刷新或重新加载浏览器页面，再次将我们注销

1.  当您按浏览器的返回按钮时，不会捕获任何请求。这是因为返回按钮操作包含在浏览器中。没有通过 Burp 发送消息到 Web 服务器执行此操作。这是一个重要的区别需要注意。尽管如此，我们发现了与弱浏览器缓存保护相关的漏洞。在这种情况下，渗透测试人员将拍摄已登录缓存页面的截图，然后点击返回按钮后看到：

![](img/00168.jpeg)

# 通过 REST API 测试帐户配置过程

帐户配置是在应用程序中建立和维护用户帐户的过程。配置功能通常仅限于管理员帐户。渗透测试人员必须验证用户提供适当的身份识别和授权来完成帐户配置功能。帐户配置的常见方式是通过**表述性状态转移**（**REST**）API 调用。许多时候，开发人员可能不会为应用程序的 UI 部分使用的 API 调用设置相同的授权检查。

# 准备工作

使用 OWASP Mutillidae II 应用程序中提供的 REST API 调用，确定未经身份验证的 API 调用是否可以配置或修改用户。

# 如何做…

确保您没有登录到应用程序中。如果登录了，请从顶部菜单中单击**Logout**按钮。

1.  在 Mutillidae 中，浏览到**User Lookup (SQL) Page**，然后选择**OWASP 2013** | **A1 Injection (SQL)** | **SQLi – Extract Data** | **User Info (SQL)**：

![](img/00169.jpeg)

1.  在**Name**中键入`user`，在**Password**中键入`user`，然后单击**View Account Details**。您应该看到下一个截图中显示的结果。这是我们将使用 REST 调用测试配置功能的帐户：

![](img/00170.jpeg)

通过 Spidering，Burp 可以找到`/api`或`/rest`文件夹。这些文件夹是应用程序启用 REST API 的线索。测试人员需要确定通过这些 API 调用可以使用哪些功能。

1.  对于 Mutillidae，`/webservices/rest/`文件夹结构通过 REST API 调用提供帐户配置。

1.  要直接转到 Mutillidae 中的此结构，选择**Web Services** | **REST** | **SQL Injection** | **User** **Account Management**：

![](img/00171.jpeg)

您将看到一个屏幕，描述了支持的 REST 调用以及每个调用所需的参数：

![](img/00172.jpeg)

1.  让我们尝试调用其中一个 REST 调用。转到**Proxy** | **HTTP history**表，并选择您从菜单中发送的最新请求，以进入**User Account Management**页面。右键单击并将此请求发送到**Repeater**：

![](img/00173.jpeg)

1.  在 Burp 的**Repeater**中，将`?`添加到 URL 后面，然后加上参数名/值对`username=user`。新的 URL 应该如下所示：

[PRE0]

![](img/00174.jpeg)

1.  单击**Go**按钮，注意我们能够以未经身份验证的用户身份检索数据！执行此类操作无需身份验证令牌：

![](img/00175.jpeg)

1.  让我们看看还能做什么。使用**User Account Management**页面上给出的 SQL 注入字符串，让我们尝试转储整个用户表。

1.  在`username=`后附加以下值：

[PRE1]

新的 URL 应该是以下一个：

[PRE2]

1.  在更改`username`参数后，单击**Go**按钮。您的请求应如下所示：

![](img/00176.jpeg)

1.  请注意，我们已经转储了数据库中的所有帐户，显示了所有用户名、密码和签名：

![](img/00177.jpeg)

1.  掌握了这些信息后，返回到**Proxy** | **HTTP History**，选择您发送到**User** **Account Management**页面的请求，右键单击，并发送到**Repeater**。

1.  在**Repeater**中，修改`GET`动词，并在**Request**的**Raw**选项卡中用`DELETE`替换它：

![](img/00178.jpeg)

1.  转到**Params**选项卡，点击**添加**按钮，然后添加两个`Body`类型参数：首先，用户名设置为`user`，其次，密码设置为`user`，然后点击**Go**按钮：

![](img/00179.jpeg)

1.  请注意，我们已经删除了该账户！我们能够检索信息，甚至在不显示 API 密钥或身份验证令牌的情况下修改（删除）数据库中的行！

![](img/00180.jpeg)

注意：如果您希望重新创建用户账户，请重复上述步骤，将*delete*替换为*put*。签名是可选的。点击**Go**按钮。用户账户将被重新创建。
