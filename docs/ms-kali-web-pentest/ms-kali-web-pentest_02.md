## 第三章。通过目标侦察追踪猎物

美国总统亚伯拉罕·林肯，尽管他可能曾经被引用，但通常（错误地）被认为曾经说过，

> “给我六个小时砍倒一棵树，我将花前四个小时磨削斧头。”

无论这句话真正来自何处，我们肯定可以将其与黑客联系起来。在网站渗透测试中的许多成功取决于我们在这里发现了什么，我们如何筛选信息，以及我们如何将其与本书后面介绍的工具相结合。在这里进行彻底和系统的方法将节省时间，集中精力，并有助于规划我们的攻击。我们在第二章中讨论的各种框架和组织的方法都包括一些信息收集方面，Kali Linux 中可用的工具应该对您来说是熟悉的。

### 注意

在本书中，我们将跟随*Penetration Testing with the Raspberry Pi â�� Second Edition*（由*Jason Beltrame*和*Mike McPhee*讨论的 Pen Test Kill Chain）的讨论，该书可在[`www.packtpub.com/networking-and-servers/penetration-testing-raspberry-pi-second-edition`](https://www.packtpub.com/networking-and-servers/penetration-testing-raspberry-pi-second-edition)上找到，如下图所示：

![](img/B03918_03_01-1.png)

Pen Test Kill Chain 有助于了解涉及何种工具。构建您自己的版本以帮助可视化工作流程。

这种信息收集有多种形式，但作为一名实践黑客，您可能已经形成了自己的偏好和惯例。开源信息收集、对目标本身进行被动侦察以及微妙、专注的扫描和*蜘蛛*的健康混合可以在很大程度上帮助制定项目的游戏计划的其余部分。挑战在于尽可能暴露更多信息，而不引起目标操作者的防御意识（也称为**偏执狂**）。我希望我能帮助提供一些调整您的流程的建议，这样您就可以在不被发现的情况下更深入地进行发现。

所有系统的普遍漏洞是用户，而 Web 应用程序为其开发人员提供了一个表达自己并展示他们的机会。有效的社会工程学往往可以绕过大量的技术工程，以获取 Web 应用程序架构的凭据和其他关键元素。我们将看看如何利用信任和自豪感来鼓励目标用户和开发人员，尽可能多地利用这种方法。

让我们不要忘记，文物本身可以帮助客户了解他们的信息曝光。敏锐的网络安全举措不仅会引起对其组织公开可用信息的关注，甚至可能会进行误导。在您的发现中，编目您的发现：客户应该因减少其公开曝光而受到赞扬。

在本章中，我们将讨论以下内容：

+   收集和使用网站的离线存档

+   使用公共资源和一个时髦的旧浏览器对您的目标进行侦察

+   使用社会工程学来黑客用户

+   自动化开源信息收集以绘制和描述目标

+   通过主动扫描识别目标的关键方面，并通过后续努力进行聚焦

## 模拟游戏

* * *

如果攻击的侦察阶段中的一个挑战让你的血液沸腾，那就是试图在不被发现的情况下找出关于一个网站的每一个细节。普通用户随机浏览网站，重点关注某些高流量交易，任何比这更有条理的行为可能引起怀疑。低效的工作流也可能引起警觉，因此能够浏览网站并制定攻击计划是一个非常有用的技巧。在这一部分，我们将看看如何创建一个网站的镜像（而不会惊动防御者），进行无风险的模拟。他们说模仿是最好的恭维方式。

我们还会发现网站镜像存在一些限制。后端数据、高级脚本和智能都无法在应用程序和数据层没有相同基础设施的情况下复制。我们可能依赖的业务逻辑无法复制，我们的最终目标——大量数据也无法以这种方式获取。我们需要更好地了解如何安全地浏览。在本节中，我们还将讨论一些更好的探测技术，以便在实际网站上进行隐蔽操作。

### 使用 HTTrack 创建（然后破坏）镜像

军事行动、体育队伍和商业提案团队在最佳状态下将对他们的战术和整体战略进行排练或完善，对抗一个模拟对手或在一个真实复制的环境中进行。这样做的好处很多，但其中最重要的是，这些排练环境提供了一个安全的环境，可以在不失去实际战斗、比赛或项目的风险的情况下建立信心和能力。在电影《奥斯汀大冒险》中，他们实际上模拟了他们要攻破的金库的完整副本来排练他们的计划。这一点是，模拟的越准确和真实，当真正的情况发生时成功的机会就越大。

现在我的电影参考结束了，想想我们作为渗透测试人员的角色。如果你可以下载一个完整网站的 HTML、JavaScript、CGI 和 CSS 代码以及层次结构，那么这不是一个探索网站的好方法吗？你和你的团队进行的所有头脑风暴现在可以用在一个复制品上，因为没有目标组织监控仪表板，我们可以测试一堆向量，而不是只担心一个。在渗透测试中，这也是一个创建本地、便于旅行的网站副本的有用方法，可以在不依赖实际网络连接的情况下使用。

这些存档也可以成为欺骗攻击的基础，让我们可以在使用**浏览器利用框架**（**BeEF**）或**社会工程工具包**（**SET**）的流氓蜜罐中托管实际的网页并进行修改。

诸如`wget`和`w3af`之类的多个网站镜像工具可以进行存档，但**HTTrack**是 Kali 中最全面的工具，可以创建一个镜像。你可能已经用它来创建基本存档，但通过一些调整，它可以做得更多。让我们来看看一些最有用的侦察 CLI 选项及其相应的**图形用户界面**（**GUI**）版本。

#### 创建一个隐秘的初始存档。

作为一个提醒，你可以通过以下步骤创建一个网站的存档：

```
httrack "http://www.hackthissite.org/" -O "/tmp/www.hackthissite.org" "+*.hackthissite.org/*"
```

`â��O`指向输出位置（一些本地可访问的驱动器，您计划从中访问镜像）。虽然帮助可能会很有用（`hattrack --help`或`man help`），但您可以从 HTTrack 网站上 Fred Cohen 提供的手册中获得更多信息（[`www.httrack.com/html/fcguide.html`](https://www.httrack.com/html/fcguide.html)）。正如*Mr. Cohen*所透露的，CLI 中有大量开关，了解其中许多的默认值对于制定自己的镜像操作非常有用。更复杂的网站将采取措施防止从诸如 HTTrack 的实用程序进行镜像，包括递归链接和目录结构，域拆分以及使用脚本混淆链接以损害您镜像它们的能力。还可能采取极端措施，如 IP 黑名单或限速，因此最好谨慎使用这些工具，并尊重网站所有者。

#### 调整更隐秘的存档

进行更隐秘的镜像操作当然值得学习，但我们需要考虑一些权衡。限制带宽和线程数量有助于使我们不被发现，但这意味着镜像操作将需要更长时间。我们可以通过过滤器和目录限制来限制我们的搜索范围，这是社会工程和我们自己的经验可以帮助解决的问题。还有其他地方可以提高效率吗？

HTTrack 处理查询时存在相当大的开销，时间和计算资源的消耗的一个重要因素是在网站上解析**多用途互联网邮件扩展**（**MIME**）类型。HTTrack 有许多可定制的功能，可以通过修改`.httrackrc`文件来利用，但我学到的最有用的一个是添加以下行，这大大缩短了我的镜像时间，从几小时缩短到几分钟。通过使用您喜欢的编辑器将这一行完整地添加到`.httrackrc`文件中，并保存文件：

```
set assume asp=text/html,php3=text/html,cgi=image/gif,dat=application/x-zip,mpg=application/x-mp3
```

一旦我对默认设置进行了修改，我发现有用的隐秘命令字符串将执行一系列非默认操作。请记住，一旦你磨练出自己的开关，你也可以将它们保存在`.httrackrc`文件中。这是我使用的命令：

```
httrack www.hackthissite.org -O /tmp/hackthissite â��c4 -%c10 â��A20000000 â��m50000000 â��m1000000' â��M100000000 â��r25 â��H2 â��www.hackthissite.org/forums/* -www.hackthissite.org/user/*
```

以下是我使用的选项的简要描述。*N*表示一个变量：

+   `-cN`：这限制了同时下载的数量或文件句柄，以避免过度压倒我们的目标

+   `-AN`：这限制了带宽以保持低调

+   `-mN`和`â��mN'`：这些分别限制了非 HTML 和 HTML 文件大小的总下载量，以确保我们不会超出磁盘空间

+   `-M`：这设置了整体镜像大小限制，再次保持磁盘大小可管理

+   -rN：这会对递归深度进行安全设置，以免陷入循环

+   -H2：如果检测到慢速流量，将停止下载

+   `-<path>/*`：这跳过了一个路径（在这种情况下，我不想下载他们庞大的论坛或用户资料）

您还可以使用 GUI 版本的**WebHTTrack**，这对学习如何调整您喜欢的过滤器和选项非常方便：

![](img/B03918_03_02-1.png)

WebHTTrack 提供了一个直观的方式来掌握过滤器和调整，并且还可以保存扫描设置以供重复使用。

这个命令对[`www.hackthissite.org/`](https://www.hackthissite.org/)网站的攻击花了一小时多一点的时间，下载了 200MB 的信息。在这个例子中，我省略了论坛和用户，但我也可以省略其他目录，以便专注于网站的特定区域，或者避免违反客户设定的界限。如果在命令行运行时按下*Enter*，你将得到一个关于运行时间、找到的链接数量以及到目前为止的总下载大小的摘要：

![](img/B03918_03_03-1.png)

状态屏幕是一个简单的方式来查看你的进展。如果你决定提前结束，按下 Ctrl + C 将退出镜像。

![](img/B03918_03_04-1.png)

WebHTTrack 的另一个优势是，你可以与存档过程中的文件进行交互以跳过文件。

当存档完成时，你可以通过在浏览器中访问本地路径来像访问实时网络一样浏览它：`file:///tmp/hackthissite/www.hackthissite.org/index.html`。

你将在下面的截图中看到，我们成功捕获了动态广告横幅内容(`infosecaddicts.com/`)，这也值得过滤：

![](img/B03918_03_05.png)

使用 HTTrack 创建的本地镜像与网站进行交互和浏览，这对于识别潜在的向量至关重要。

#### 镜像是否完整并且是最新的？

有很多开关可以让你去探索，但有一个特别有用的开关可以帮助我们镜像网站上开发者告诉 Google、Yahoo 和其他爬虫忽略的地方。`robots.txt`文件或元标记用于告诉浏览器跳过存档或搜索扫描。他们通常这样做是为了避免允许某些东西被搜索，这在渗透测试中肯定是有趣的。添加`â��s0`选项可以确保我们在扫描中不会漏掉任何东西。

更新我们的镜像是一个非常简单的过程。假设你将它存储在一个非易失性位置（`/tmp`在重新启动时会消失），你可以手动收集，甚至分配一个**cron**任务来自动更新你的镜像内容和链接。一个提示将确保你的意思是更新缓存；假设是这样，它将删除锁定文件并执行更新。我建议探索存档开关，可以让你保留旧文件或执行增量更新，以更好地利用你的时间。一些旧的副本可能包含被删除以掩盖无意中披露的内容，因此值得保存一些历史文件，直到它们被扫描。

### 注意

在离开 HTTrack 讨论之前，值得一提的是，在练习已知网站时，调整你的选项和设置可以使你的镜像过程更加高效和有用。一定要做笔记和记录你喜欢的替代方案！

![](img/B03918_03_06.png)

HTTrack 提供智能更新，这可以节省带宽和时间。如果需要，还可以使用 CLI 选项进行多个副本和版本。

#### 参观目标环境

本地副本允许我们以安全的方式审查网站，但我们从哪里开始呢？手动的实际扫描将帮助我们了解流程，并给我们一些关于下一步的提示。我首先建议了解网站的层次结构以及各种动态内容门户可能存在的位置。用户可以在哪里登录托管的应用程序，查询信息，或提供/查看反馈？我们还应该记录我们可以在以后用来枚举名称、电子邮件地址和组织信息，并更好地理解实体关系的实体信息。如果我们要重新利用这个镜像进行 MITM 或蜜罐任务，我们希望能够复制不仅外观和感觉，还有工作流程。

存在一些工具可以帮助进行这些漫游，比如那些揭示底层 HTML 和 JavaScript 元素的工具。通过 Firefox 的开发者工具查看页面源代码，使用 OWASP Mantra 附加包中的插件 HackBar 或其他 HTML 查看器。为了节省时间，我建议除了最初熟悉应用程序或网站之外的任何事情都要使用完整的代理工具集，比如 Burp 或 Firebug。使用 Web 应用程序测试套件（在接下来的几章中介绍）可以帮助您有效地从侦察阶段转移到武器化、利用或安装阶段的活动。

## 开源的强大

* * *

在接受任务或工作之前，我做的第一件事是弄清楚我要面对什么。以前并不总是这样。作为一名年轻的通信系统工程师，我曾被要求领导一个听起来很酷的子系统规范的开发。哇哦，这是一个闪耀的时刻！我基于团队负责人提供的销售说辞做出了承诺。现实在我接受任务的第二周左右击中了我，因为只有在那时我才能从键盘上抬起头来设想我前方的道路。如果我在承诺之前做了那项研究，我本可以避免前方的麻烦。不用说，工作完成了，但我总是回想起来，想知道它本可以做得更好，如果我在接受任务之前研究了过程、约束和期望，我会更快乐、更休息。

渗透测试也不例外。虽然一些测试人员（事实上，黑客也是如此）可能在研究目标之前接受工作，但经验丰富的专业人士采取了不同的方法，并做好了功课。我们都是谷歌搜索专家，但我们可以改进这些查询的方式，并利用其他工具来完善我们对目标的了解。我们需要利用搜索引擎、社交媒体、论坛和其他公共领域信息之间的许多链接。下图向我们展示了原始的开源情报（OSINT）来自许多来源，可以通过搜索引擎和 Kali 的工具集来访问。有效利用 OSINT 有助于更好地理解项目的要求，并可以帮助我们制定策略，发现漏洞，收集用户信息，并获取有助于我们绘制基础设施的详细信息。我们将看一些可能熟悉的工具，但我们将看看是否可以发掘它们更多的潜力。

![](img/B03918_03_07-2.png)

浏览器和 Kali 的工具集可以帮助访问大量的 OSINT。

### 开源情报与谷歌和谷歌黑客数据库

搜索引擎现在已经成为我们超连接的全球社会的重要组成部分，以至于很容易忽视每个引擎的优势和功能。在美国，Google、Bing，以及在较小程度上的 Yahoo 主导了市场，但考虑到我们作为渗透测试人员的角色可能跨越国界，与引擎及其本地化合作以确保我们获得最新的信息是很有用的。Search Engine Colossus（https://www.searchenginecolossus.com）提供了每个国家的领先选项，包括那些受到禁运的国家。特别是那些非技术领域的一般信息搜索，应该包括目标地区或其合作组织的本地搜索引擎。然而，谷歌的搜索引擎提供了出色的覆盖范围和自己的广泛语法，可以将这些一般引擎的发现与极大的效力一起使用，以发现架构细节、敏感文件和潜在的进入目标服务器的途径。

#### 调整你的谷歌搜索技能

有一些专门讲解提高谷歌搜索技能的书籍，但对于网络渗透测试，我们可以专注于一些可以更好地利用引擎并消除无用搜索结果的技巧和实践，通常称为噪音。我们可以使用一些操作符来过滤或聚焦我们的结果，而其他操作符将执行逻辑组合或修改引擎的行为。让我们先看看最有效的修饰符和选项，首先是过滤或聚焦，然后是逻辑操作符：

+   **站点：操作符**：使用站点：操作符告诉谷歌的引擎只接受托管在特定域上的文件。当我们正在寻找合法的联系信息、暴露的文件和内容时，我们将使用此操作符，以便让我们纯粹地专注于该域的结果，而不是在页面点击顺序中的链接的完整转储，这可能会垃圾邮件许多其他网站。例如，在 Cisco ASA 文档的搜索之前（左）和站点：操作符之后（右）：

![](img/B03918_03_08-1.png)

站点：操作符是一个很好的第一个过滤器，可以确保结果集专注于您的目标。

+   **凭证操作符**：使用关键词如`username`、`password`、`userid`、`pwd`、`passcode`、credentials 或任何其他变体可以帮助我们找到密码或用户名恢复详情。对这些术语进行快速有针对性的搜索不仅可以指向您可能要定位的门户入口，而且实际上可能提供解锁它们的钥匙。我们将在本书的后面讨论使用默认凭证对这些查询结果的影响：

```
site:<target site> username|userid|password|passcode|pwd
```

![](img/B03918_03_09.png)

凭证搜索可能不会产生凭证本身，但可能指向下一个最好的东西——恢复！

+   **网址：操作符**：对目标进行早期侦察，包括从社会工程学中学到的经验教训，可能会为我们提供有关所使用的平台、涉及的开发人员或网页应用程序中的兴趣点的线索。我们可以将网址：操作符与站点：操作符结合使用，以探索这些特定的兴趣点：

```
site:<target site> inurl:index
```

![](img/B03918_03_10.png)

Inurl: 可以帮助消除成千上万个潜在位置并聚焦。

+   **文件句柄（ext：）操作符**：使用标准文件句柄允许我们调用和包括（或排除）感兴趣的文件扩展名。使用典型的文件扩展名，您可以使用 ext：操作符调用每个文件。例如，我们可以使用以下字符串在[www.hackthissite.org](http://www.hackthissite.org)中搜索所有带有 URL 中包含单词 index 的 PHP 文件：

```
site:<target site> ext:php inurl:index
```

+   **文件类型：操作符**：如果我们正在寻找可能不会显示但链接到或存档在网站上的文件类型，我们可以使用文件类型：操作符。例如，在您的搜索中调用`filetype:xls`，将搜索您的搜索区域以查找 Excel 电子表格：

```
site:<target site> filetype:xls inurl:finance
```

+   **标题：操作符**：当我们想要一个特定的文件时，我们可以使用标题：操作符。这对于定位特定平台配置文件非常有用，或者可以帮助暴露`robots.txt`文件。正如您可能还记得我们使用 HTTrack 时，该实用程序的默认行为是避免爬行网站中`robots.txt`文件中标识的部分。这是为了让网站开发人员防止可信浏览器搜索到某些必要但敏感的位置。如果没有采取其他预防措施，`robots.txt`可以为黑客提供他们可能想要查看的文件和文件夹列表。对于黑客来说，有很大的机会在其中找到一些非常有用的细节。要查看`robots.txt`文件中的内容，您可以简单地输入：

```
site:<target site> intitle:"index.of" robots.txt
```

前述每个操作符都可以单独或组合使用来帮助缩小搜索范围，但了解更多关于谷歌搜索引擎的处理方式也可以帮助我们消除多余的信息并理解结果。以下是一些快速提示的亮点：

+   使用逻辑运算符**OR**是有帮助的（**AND**是默认的）。如果写出来，OR 必须始终大写才能被视为逻辑 OR，否则它将被视为搜索短语的一部分。您还可以使用**|**运算符，通常称为**管道**运算符。

+   Google 搜索将专注于搜索短语的前 10 个非平凡单词。在搜索短语中使用*****来代替可选或丢弃的单词不会计入十个单词的限制，但可以有效地扩展搜索短语，以进行更复杂的搜索。

+   您可以在操作符或过滤器之前使用**-**来排除（否定）该过滤器或操作的效果。例如，我们想要确定除了 Web 服务器之外，特定域名可能呈现的其他内容：

```
site:packtpub.com â��site:www.packtpub.com
```

![](img/B03918_03_11.png)

使用“-”修饰符可以从结果集中排除一个过滤器。

+   这与关键词**NOT**不同，后者实际上只能用于从搜索中排除一个词，对特殊操作符没有影响。如果我们运行以下命令，将会产生大量**www**的结果，与使用**-**作为修饰符的搜索不同：

```
site:packtpub.com NOT site:www.packtpub.com
```

![](img/B03918_03_12.png)

仅使用 NOT 排除该字符串 - 如果您不预期它，这是没有用的。

#### 与 Google Hacking DB 和 Netcraft 一起更智能地工作

Google 搜索技巧将始终有用，但对于黑客来说，最有用的字符串大部分都被收录在**Google Hacking 数据库**（也称为**Exploit DB**）中，这是由 Offensive Security 团队托管的项目（[`www.exploit-db.com/google-hacking-database/`](https://www.exploit-db.com/google-hacking-database/)）。虽然浏览很有趣，但最好的用法是用它来启发您的搜索查询，将它们的字符串与前一节中的修饰符结合起来。

它们的大部分类别对于 Web 渗透测试很有用，但我会从**Web 服务器检测**查询开始：

![](img/B03918_03_13.png)

Google Hacking DB 中有很多可以重新利用的出色搜索查询。

这些查询以及其他类别，如**易受攻击的服务器**、**敏感目录**等，结合`inurl:`和`site:`修饰符，可以帮助我们高层次地了解环境中的暴露情况。如果你幸运地发现了凭证或漏洞，这些信息应立即披露给您的客户。这些搜索在黑客领域的两边都在持续使用，这类信息不应该等到总结之后才披露。

总部位于英格兰巴斯的公司**Netcraft**提供了许多服务，但他们的免费网络扫描工具（[`searchdns.netcraft.com`](https://searchdns.netcraft.com)）是一个非常方便的扫描器，可以帮助更加详细地聚焦。您可以搜索域名并深入到所有可以基于对无害查询的响应进行公开分析的技术和版本的报告中。在他们的网站上快速搜索[`www.packtpub.com/`](https://www.packtpub.com/)，我们发现他们目前有两个邮件 IP 地址，正在 FreeBSD 上托管 Packt 平台。报告还告诉我们什么？

![](img/B03918_03_14.png)

Netcraft 的在线网络扫描工具让我们对未来阶段有了很好的了解。

我们可以看到有两个跟踪器（Google 和 Amazon）。服务器端使用 XML 和 SSL，客户端使用 JavaScript，Drupal 既用作**内容管理系统**（**CMS**）又用作 PHP 脚本引擎，同时还使用 HTML5 和 CSS 样式表。所有这些都有助于优化我们的渗透测试方法。

### 精通您自己的领域

搜索引擎易于访问，但我们还需要了解网络的域结构、寻址计划和支持服务，因为这种视角对我们探测应用程序至关重要。托管应用程序的域可能具有复杂的域结构，可以被利用。主机、网络 IP 地址和块、名称服务器以及相关元素可以帮助识别目标实体、转移到相邻主机、底层服务和守护程序，以及正在使用的开放端口和协议。我们将研究一些工具，这些工具将其中一些工具整合到一个更大的解决方案中，但是精通**dig**、**fierce**、**dnsenum**、**dnsmap**、**WHOIS**和**DNSRecon**将大大提高准确性和效力。

WHOIS 数据库自互联网早期以来就已经在使用，尽管复杂的服务提供商和托管范式意味着 WHOIS 很少包含域的最终用户及其联系信息，但正是这些信息可以启动调查。我们在经验中都使用过它，因此我们将进入下一级工具。

#### 挖掘信息

DNS 记录为与域的各种功能相关联的 IP 地址提供了人类可关联的别名。我建议定期对 DNS 操作和相关记录类型进行全面审查，以确保您始终了解 DNS 使用中的任何新趋势，并唤起您的记忆。发现新的应用程序和协议借用 DNS 记录空间是很常见的。保持 DNS 知识的新鲜确保您能够充分利用这些新应用程序。

实用程序`dig`一直是 DNS 枚举的渗透测试社区的中流砥柱；很可能你已经使用过它，并且有一些你喜欢使用的开关。在进行网络渗透测试时，我们将集中在答案字段上，并且利用`dig`提供的各种开关，我们可以使用它来映射其他相关的记录类型。

##### 挖掘记录类型

`dig`可以用于快速而轻松地查询和映射与**A**、**MX**、**NS**、**SOA**或其他记录相关的记录类型。默认是 A 记录，表示域的主要 IPv4 地址，但您可能只想定位相关的名称服务器（NS 记录），例如尝试进行中间人攻击。例如，域的 MX 记录和指向域上的邮件服务器的指针可以用于制定钓鱼攻击以针对用户。如果我们想查看与域相关的所有记录类型，我们可以使用`ANY`关键字：

```
dig packtpub.com ANY
```

![](img/B03918_03_15.png)

基本的`dig`输出-有用，但可以更简洁。

为了找到与 Packt Publishing 相关的邮件服务器，我们只需输入 MX 关键字来过滤那些记录类型。

基本`dig`输出中的每个子部分都可以通过命名特定部分来过滤，例如`+nocomments`，`+noquestion`，`+noauthority`，`+noadditional`或`+nostats`。要关闭所有这些部分，您可以使用`+noall`快捷方式，然后在末尾打开所需的部分（例如`+answer`），如下所示：

```
dig packtpub.com ANY +noall +answer
```

![](img/B03918_03_16.png)

将`dig`输出缩短，只关注我们感兴趣的记录

`+short`修饰符也可以消除大量多余的信息，并且值得附加到您的标准查询中，以帮助缩短输出。

`dig`还提供了执行**区域传输**的能力，如果目标没有受到保护，允许攻击者下载域的整个转发区域。这只应该发生在域上的合法域名服务器之间，成功的区域传输对攻击者来说是一笔意外之财，我们应该始终测试和寻找。为了演示区域传输，我们将使用出色的培训网站 Diji Ninja 自己的域名（[`digi.ninja/projects/zonetransferme.php`](https://digi.ninja/projects/zonetransferme.php)）并输入以下内容：

```
dig axfr @nsztm1.digi.ninja zonetransfer.me
```

![](img/B03918_03_17.png)

进行区域传输是一件了不起的事情，当它成功时。

`dig`提供了一个清晰简单的工具集，但通常，目标环境比`dig`可以呈现的要大，或者我们正在寻找更深入的结果。这就是`dnsrecon`的用武之地。我建议使用`dnsrecon`重复相同类型的练习，以了解它与 dig 的比较，并帮助您确定哪个工具将成为您的主要工具。

#### 变得凶猛

`dig`和`dnsrecon`是很棒的工具，但如果我们能进一步并拥有一个工具，它尝试连接到站点的地址块，自动执行区域传输，并在记录时执行所有这些操作，那不是很好吗？**Fierce**（由 Robert *RSnake* Hansen 用 Perl 编写）可以做到这一点。在调用 Fierce 时可以使用许多选项和修改器，但在大多数情况下，我使用 dig 进行初始发现，然后转到 Fierce 尝试进行区域传输和一些连接探测，然后转到更具图形化和组织性的工具，如 Maltego，来构建我的网络地图和枚举关系。要使用 Fierce 尝试进行区域传输并将日志发送到文件，您只需调用该工具，它将自动执行：

```
fierce -dns zonetransfer.me -file /root/Desktop/packtpub.txt
```

因为这个网站允许区域传输，所以我会在运行输出和我指定的`txt`文件中看到结果：

![](img/B03918_03_18.png)

Fierce 自动化了需要进行多次 dig 或 dnsrecon 查询的操作。

Fierce 还允许您尝试使用`-connect`开关连接任何公共 IP 上的开放端口。您需要提供`wordlist`，以便 Fierce 有一些潜在的凭据可供尝试，并且您需要在专用机器上或在夜间运行此操作，因为该过程可能需要很长时间，具体取决于域的大小。我们可以使用以下方式启动此操作：

```
fierce -dns <target domain> -connect <wordlist>
```

#### Nikto 的下一步

一旦我们获得了完整的 DNS 记录和其他相关情报，通常会转入扫描漏洞（也称为**vulns**）。**Nikto**是我首选的扫描器，我通常会保留这些结果，以便调整扫描漏洞的工具，同时转入后续阶段。Nikto 可以导出多种文件类型，包括 HTML、XML、TXT 和 CSV，并且使用它开始了主动侦察阶段。

### 注意

因为它是一个主动工具，它的使用构成了一个合法的挑衅行为，因此建议只在实验室机器上进行实践，并且只对您有明确许可的系统进行测试。我没有足够的抵押品来代表您发布保释金。

要使用 Nikto，我们需要确定主机或主机列表（在主机文件中定义），以及输出日志的位置，但有一个广泛的菜单项目列表值得考虑，以定制我们的扫描。除了输出文件和日志参数之外，实际上还有预定义的调整可用于针对指定主机运行一些常见的最佳实践测试集。这些选项是使用 Nikto 进行扫描的最佳捷径，并在主页中有详细说明：

```
-TuningTuning options will control the test that Nikto will use against a target. By default, if any options are specified, only those tests will be performed. If the "x" option is used, it will reverse the logic and exclude only those tests. Use the reference number or letter to specify the type, multiple may be used:0 - File Upload1 - Interesting File / Seen in logs2 - Misconfiguration / Default File3 - Information Disclosure4 - Injection (XSS/Script/HTML)5 - Remote File Retrieval - Inside Web Root6 - Denial of Service7 - Remote File Retrieval - Server Wide8 - Command Execution / Remote Shell9 - SQL Injectiona - Authentication Bypassb - Software Identificationc - Remote Source Inclusionx - Reverse Tuning Options (i.e., include all except specified)
```

默认扫描将运行所有测试，但如果有限制，这些调整可以帮助保持测试的合规性。当您需要匿名时，可能还希望利用一个有意义的代理（您已经建立的代理或许多免费代理之一（例如[`proxy-list.org`](http://proxy-list.org)上的代理），或者更好的是，您已经为此目的而受到限制的主机）。为此，您将使用您喜欢的编辑器在`config.txt`中指定代理服务器（或显式调用替代方案）。**Nano**是我的第一选择，但**vim**或**emacs**也可以很好地工作：

```
nano /etc/nikto/config.txt
```

滚动到**`P`****`roxy settings`**部分，并输入适当的详细信息：

```
# Proxy settings -- still must be enabled by -useproxy PROXYHOST=<IP address of proxy>PROXYPORT=<usually 8080, can be anything if using something like squid>
```

然后，我们可以使用配置的代理启动我们的扫描，如下所示：

```
nikto -Tuning x 6 9 -useproxy -h http://192.168.1.132
```

![](img/B03918_03_19.png)

Nikto 是一个多才多艺、强大的扫描器——在封闭环境中进行实践会产生巨大的差异。

与任何工具一样，有时重要的是意识到要避免哪些开关。对于黑盒测试（使用更真实的隐蔽特权进行的渗透测试，其中测试人员试图模拟攻击者，并且没有任何有利的访问权限），必须避免导致过多查询和啰嗦扫描的选项，大多数情况下`+mutate`开关不值得麻烦。如果进行白盒测试（对操作员已知，不专注于隐秘，并且只是在公开中探索），那么提供更广泛的覆盖范围是有意义的。

### 利用 Maltego 进行组织

**Maltego**是我最喜欢的侦察工具之一，因为它帮助可视化不同数据源之间的许多链接和关系。*Jason Beltrame*和我在*Penetration Testing with Raspberry Pi â�� Second Edition*中对其进行了介绍（[`www.packtpub.com/networking-and-servers/penetration-testing-raspberry-pi-second-edition`](https://www.packtpub.com/networking-and-servers/penetration-testing-raspberry-pi-second-edition)），但自那时起，我已经开始在无法想象的用例中使用它。尽管投入其中很有趣，但肯定有一些最佳实践有助于避免信息过载。Kali 发行版中最新版本 4.0.11 包括新的足迹技术，如**Company Stalker**、**Find Wikipedia Edits**、**Twitter Digger**和**Monitor**。所有转换都可以在 Web 渗透测试中使用，但这些新的以社交为重点的起点强调了**Paterva**的努力，使 Maltego 成为所有黑客社区不可或缺的工具。

我倾向于将其用作从社会工程、LinkedIn/电子邮件搜索中获取的信息的图形文档，并将它们固定在域上。对实体进行转变和转换的能力甚至帮助我发现了多个跨多个托管公司的域，经过两三层混淆后实际上是由同一网络的骗子运营的。通过转换的递归可以帮助找到可能具有本地帐户的其他用户，或者指示可能填充我们的字典的亲戚或朋友的姓名和信息。一个快速的例子是对 Packt Publishing 的网域进行公司跟踪机器：

![](img/B03918_03_20.png)

这个 Maltego 图已经缩小，以保护无辜者，同时也展示了它所跟踪的信息的关联性质。

如您所见，基础机器的进程中发现了几个文档（橙色点），每个文件都有关联的元数据，如人员（绿色）、证书（黄色）和位置（红色）。如果我们深入研究一个人，我们可以要求进行搜索所有潜在的电子邮件地址的转换（蓝色）。我发现当您向 Maltego 提供来自其他 OSINT 来源的额外种子信息以帮助聚焦或推动模型链接原始机器和其他信息时，Maltego 非常有帮助。您可以添加任何形式的身份，但额外的 Web 域或电子邮件地址、社交网络用户名或 IP 块和接口可以极大地提高 Maltego 图的准确性和有用性。

## 与目标社交

* * *

如果您没有使用**社会工程师工具包**（**SET**，[`www.trustedsec.com/social-engineer-toolkit/`](https://www.trustedsec.com/social-engineer-toolkit/)），那么您就错过了一些重要的东西。我们当然可以用它来欺骗 Google、Facebook 和 Twitter 来吸引受害者并发动攻击或窃取他们的凭证，但我们也可以用它来欺骗我们的目标 Web 应用程序，以劫持会话并映射用户行为。当受害者在咖啡店的舒适椅子上无意中浏览这些重复的网站时，攻击者可以收集受害者的密码，甚至注入一个命令 shell，从而完全访问受害者的系统。对于安全专业人员来说，这是一个很好的工具，可以演示用户通常不会注意输入敏感信息的位置，只要页面看起来合法。让我们看看如何使用 SET 对我们从[www.hackthissite.org](http://www.hackthissite.org)下载的镜像进行攻击。这是一个我们可以用来帮助设想这种攻击的图表：

![](img/B03918_03_21-2.png)

SET 可以用于许多攻击，但谁不喜欢经典的 MITM 呢？

我的典型用途是选择选项**`1)社会工程攻击`**，然后选择**`2)网站攻击向量`**。我要找的是**`3)凭证窃取攻击方法`**，这样我们就可以获取我们可怜的目标用户的登录凭证。我们可以使用内置模板或导入自定义站点（对企业门户或使用较少的 Web 应用程序很有用）；但为什么我们不想使用我们已经捕获的镜像呢？我们会选择选项**`3)自定义导入`**。这将把我们的 Kali Linux 虚拟机变成[www.hackthissite.org](http://www.hackthissite.org)的恶意前端，表现得像真的一样，并且可以抓取凭证或任何其他基于 HTML 的信息字段：

`**`![](img/B03918_03_22.png)`**

使用先前镜像的 SET 配置-修改和调整以使其更具说服力。

快速检查我们的镜像显示它现在已经运行起来了；我们现在的任务是说服用户将他们的初始会话重定向到这里。

![](img/B03918_03_23.png)

快速检查我的网站副本显示我们的 MITM 克隆已经准备就绪。

在**`登录`**字段中输入一些凭证并提交它们，我可以看到它们被实时捕获并记录在日志文件中。

![](img/B03918_03_24.png)

任何到达的 HTTP 消息都会被捕获，因此凭证或个人信息就是我们的了。`## 摘要

* * *

正如我在本章开头提到的，侦察阶段可以决定后续阶段的成败。信息收集将为您的破解和模糊操作提供数据，将搜索范围缩小到更易管理的范围。在专注于测试中节省的工作转化为更严格的测试标准，更成功的测试方法，更少的翻转和试错，以及更有意义的报告。客户通常在这个阶段学到的东西和在剩下的阶段学到的一样多，这提出了一个关键问题。关于他们的系统和使用它们的人在线上可获得的信息的质量和数量可能会对未来产生重大影响。积极采取行动来限制或减少这种曝光将改善他们的安全状况，并且应该得到鼓励和指导。

在本章中，我们探讨了一些最流行的 OSINT 收集工具的更深层用途。我们看到了如何快速映射 Web 应用程序托管架构中的各种网络和域组件，甚至开始使用更紧凑的命令行选项扫描基础设施，以获得比默认设置更简洁和有用的数据。我们还深入研究了更好地使用搜索引擎，并利用了一些流行的在线资源，这些资源记录了一些真正可怕的查询字符串。我们讨论了许多形式的社会工程学，并建立了自己的 MITM 攻击，以捕获基于我们镜像网站的凭据。最后，我们看了 Maltego 如何开始解开目标环境的层，并帮助可视化我们的对手。

在下一章中，您将学习如何使用 Arachni 框架更有效地对 Web 应用程序进行快速扫描。作为一个拦截代理来与服务器和客户端之间的对话进行交互，我们将看到 Arachni 如何进一步自动化一些攻击，提供额外的测试向量，启动扫描，跟踪 DOM 和 JavaScript 环境中的流程。作为一个额外的奖励，您将学会使用 Arachni 来模拟移动平台，甚至生成更高质量的报告，无论是作为独立报告还是作为多工具渗透测试交付的基础。本章的工作即将取得回报，朋友们！
