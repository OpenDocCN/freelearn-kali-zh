# 第八章：主动信息收集

在渗透测试的侦察阶段，主动信息收集可以提供非常有用的结果。通过这种主动方法，渗透测试人员直接连接到实际目标，收集**开源情报**（**OSINT**）无法提供的具体细节。使用主动信息收集，渗透测试人员能够创建目标的非常详细的概要，收集操作系统类型和运行服务等信息。这些信息有助于研究和识别与目标相关的漏洞，从而缩小选择特定利用方式的范围。 

在整个本章中，我们将专注于直接与目标进行互动，以收集有关其特定细节的信息，以帮助我们对任何正在运行的服务进行概要。了解如何执行主动侦察将为我们在利用阶段提供重要的帮助。在信息收集阶段，您将能够识别漏洞并确定适当的利用方式来入侵系统和网络。您还将能够从网络设备和系统中检索敏感信息。

在本章的过程中，我们将涵盖以下主题：

+   了解主动信息收集

+   DNS 询问

+   扫描

+   Nmap

+   Hping3

+   SMB、LDAP 枚举和空会话

+   使用 EyeWitness 进行网络足迹和枚举

+   Metasploit 辅助模块

# 技术要求

以下是本章的技术要求：

+   Kali Linux: [www.kali.org](http://www.kali.org)

+   Wireshark: [www.wireshark.org](http://www.wireshark.org)

+   JXplorer: [`github.com/pegacat/jxplorer`](https://github.com/pegacat/jxplorer)

+   EyeWitness: [`github.com/FortyNorthSecurity/EyeWitness`](https://github.com/FortyNorthSecurity/EyeWitness)

# 了解主动信息收集

主动信息收集使用直接方法与我们的目标进行互动；它实际上涉及在我们的机器和目标网络和系统之间建立连接。通过执行主动信息收集，我们能够收集特定和详细的数据，如活动主机、运行的服务和应用程序版本、网络文件共享和用户帐户信息。

执行主动信息收集确实存在被检测的风险。

确定活动主机将让我们了解在线设备的数量。针对离线设备没有意义，因为它将无法响应。了解目标上的操作系统和运行的服务将帮助我们了解该设备在网络中的角色以及为其客户提供的资源。

例如，如果在主动信息收集过程中在目标系统上找到了大量文件共享，这可能意味着目标可能是一个具有大量重要数据的文件服务器。在执行主动信息收集时，攻击者的机器（在我们的案例中是基于 Kali Linux 的机器）向潜在受害者发送特殊查询，希望受害者机器会通过提供某种机密信息（如网络共享和服务版本）来回应。

现在您对主动信息收集有了更好的理解，让我们深入探讨以下各节中的实践。

# DNS 询问

作为未来的网络安全专业人士，理解各种应用程序和网络协议的目的非常重要。在本节中，我们将专注于一个特定的协议：**域名系统**（**DNS**）。

让我们首先进一步了解 DNS 的作用以及作为渗透测试人员如何获取信息。

# DNS 是什么，为什么我们需要在网络上使用它？

DNS 就像一个包含名称、地址和电话号码的电话目录。DNS 用于网络——组织的内部网络和互联网上的外部网络。DNS 协议用于将主机名（域名）解析为 IP 地址。

在 DNS 出现之前，每台计算机都包含一个位于`C:\Windows\System32\drivers\etc`目录中的`hosts`文件。为了确保用户能够通过指定其主机名或域名到达各种网站或服务器，需要经常更新此文件。如果没有`hosts`文件，用户需要指定他们想要访问的服务器的 IP 地址。

网络上的所有设备都有一个分配的 IP 地址。记住要访问的每个服务器或网站的所有 IP 地址将是非常具有挑战性的。如果`hosts`文件不包含新服务器和网站的最新记录，用户将难以到达他们的目的地。

以下屏幕截图显示了 Windows 操作系统的`hosts`文件中的当前条目：

![](img/e917ba89-ee3a-46d0-87d6-56818b1b673e.png)

Windows 主机文件记录

DNS 帮助我们避免依赖`hosts`文件。许多知名的互联网公司，如思科、谷歌和 Cloudflare，都建立了包含几乎每个互联网域名记录的公共 DNS 服务器。为了进一步阐述，让我们用一个简单的例子来帮助您理解 DNS 的工作原理。

想象一下，您想访问一个网站，比如[www.example.com](http://www.example.com)：

1.  每当计算机或设备需要将主机名解析为 IP 地址时，它会向其 DNS 服务器发送 DNS 查询消息，如下图中的*步骤 1*所示。

1.  DNS 服务器将检查其记录，并在下图中的*步骤 2*中向客户端计算机提供域的 IP 地址。

1.  最后，客户端收到 IP 地址，并在下图中显示的*步骤 3*中与`www.example.com`域建立会话：

![](img/b062ba1c-4040-4a76-a34f-bd46e6318028.png)

DNS 交易

互联网上有许多公共 DNS 服务器；其中一些具有恶意性质，捕获您的 DNS 信息并将您重定向到有害的网站和域。因此，我建议在所有网络设备和计算机上使用受信任的 DNS 提供商，以提高您的在线安全性。以下是互联网上一些知名的 DNS 服务器：

+   Cloudflare DNS：[`1.1.1.1/`](https://1.1.1.1/)

+   Google Public DNS：[`developers.google.com/speed/public-dns/`](https://developers.google.com/speed/public-dns/)

+   Cisco OpenDNS：[`www.opendns.com/`](https://www.opendns.com/)

此外，DNS 服务器不仅将主机名解析为 IP 地址，还包含用于各种类型解析的各种记录。

以下是不同的记录类型：

![](img/6e4b82f0-90c5-48cb-9e0a-627241b01a4a.png)

DNS 记录类型

**A**记录类型的示例将是将`www.example.com`的主机名映射到 IPv4 地址`93.184.216.34`；相同主机名的**AAAA**记录将包含 IPv6 地址`2606:2800:220:1:248:1893:25c8:1946`，依此类推。

`nslookup`实用程序是验证 DNS 信息的非常有用的工具。 `nslookup`可以执行各种任务，例如解析给定域的每种类型的 DNS 记录，并且具有查询特定 DNS 服务器的能力。

**DNS 枚举**是探测特定组织域的特定 DNS 记录的技术。换句话说，我们询问 DNS 服务器有关目标组织的 IP 地址和服务器名称。此外，我们尝试执行 DNS 区域传输。**DNS 区域传输**将允许将区域文件从主 DNS 服务器复制到另一个 DNS 服务器，例如辅助 DNS 服务器。

然而，DNS 服务器管理员有时会忘记应用安全控制以防止将区域文件复制到未经授权的服务器。成功的 DNS 区域传输可能导致渗透测试人员获取企业网络布局。在最坏的情况下（对于被定向的组织来说），组织可能没有在其 DNS 服务器上分离内部和外部命名空间。这样的错误配置可能导致某人为恶意目的获取这样的信息。

在接下来的练习中，我们将尝试提取给定域的各种 DNS 记录：

+   DNS 枚举

+   DNS 区域传输

+   使用`host`实用程序进行 DNS 分析

+   使用**Fierce**进行 DNS 询问

让我们深入研究并在 Kali Linux 上享受一些与 DNS 相关的乐趣！

# 执行 DNS 枚举和区域传输使用 dnsenum

dnsenum 是一个非常简单易用的工具，用于枚举和解析给定目标的 DNS 信息。此外，它具有使用**名称服务器**详细信息自动执行 DNS 区域传输的能力：

1.  打开一个新的终端窗口并执行`dnsenum`命令。帮助菜单将显示，提供各种操作符/参数及其用法的详细描述。

1.  使用`dnsenum zonetransfer.me`命令对`zonetransfer.me`域执行 DNS 枚举，如下面的屏幕截图所示：

！[](img/4195abba-027d-480e-97fd-800e33abba18.png)

dnsenum

dnsenum 将尝试获取给定域的所有服务器和主机名。我们能够获取找到的每个服务器和主机名的名称服务器、邮件服务器（用于电子邮件交换）和 IP 地址。

1.  dnsenum 将尝试通过查询枚举过程中找到的特定名称服务器来执行 DNS 区域传输，如下面的屏幕截图所示：

！[](img/f5f241fe-9328-4b4f-896e-082f394169bf.png)

DNS 区域传输

就像前面的片段一样，dnsenum 工具能够成功地从`nsztml.digi.ninja`名称服务器中提取/复制**主区记录**。使用找到的信息，渗透测试人员将更好地了解目标组织（`zonetransfer.me`）的内部和外部网络设备。

访问敏感信息，例如我们发现的信息，可能会导致成功地入侵目标组织的网络。

接下来，我们将尝试使用本机 Linux 工具进行 DNS 分析。

# 使用`host`实用程序进行 DNS 分析

`host`实用程序是 Linux 操作系统的本机工具，可以帮助我们获取有关目标域的各种 DNS 信息：

1.  在 Kali Linux 上打开一个新的终端并执行`host zonetransfer.me`命令；`host`工具将尝试获取域的 DNS 记录，如**A**和**MX**记录：

！[](img/bb8cb216-fd91-4deb-8354-669c799333d1.png)

使用`host`检索 DNS 记录

1.  使用`host -t ns zonetransfer.me`命令尝试通过获取域的名称服务器来进行枚举。`-t`操作符允许您指定 DNS 记录：

！[](img/8df4df6e-b71b-45c0-8215-4a0679b422ef.png)

名称服务器记录

1.  现在我们已经获取了域的名称服务器，让我们利用迄今为止收集的信息。让我们尝试通过使用`host -l zonetransfer.me nsztml.digi.ninja`命令查询域的名称服务器来执行 DNS 区域传输，如下面的屏幕截图所示：

！[](img/8bedac8b-859f-4508-9ae7-4b8f86edc438.png)

使用主机进行 DNS 区域传输

确保查询给定域的所有名称服务器 - 有时，一个服务器可能配置错误，即使其他服务器已经得到了保护。

现在您已经具备执行 DNS 枚举和区域传输的技能，让我们尝试使用 DNS 发现子域。

# 使用 dnsmap 查找子域

**dnsmap**与我们在前面的示例中看到的工具有些不同。dnsmap 尝试通过查询 Kali Linux 操作系统上的内置单词列表来枚举组织域名的子域。一旦找到子域，dnsmap 将尝试解析 IP 地址。

使用`dnsmap microsoft.com`命令，我们能够找到组织的子域和它们对应的 IP 地址：

![](img/150a577c-3a18-46ee-be35-617dd1f91147.png)

dnsmap 结果

如前一节所述，发现组织的子域可以导致在域中找到隐藏的敏感门户和目录。

正如您可能已经注意到的，到目前为止我们使用的每个工具都为我们提供了更多的细节。在下一节中，我们将使用更具侵略性的工具来帮助我们提取有关目标域的更多细节。

# 使用 Fierce 进行 DNS 审讯

Fierce 被认为是一种半轻量级的 DNS 审讯工具。它对给定目标域的 IP 空间和主机名执行广泛的查找。要使用 Fierce，我们可以执行`fierce -dns example.com`命令，如下面的屏幕截图所示：

![](img/f5b43e27-e343-40e5-9fe8-a6f01fe70811.png)

Fierce DNS 审讯

Fierce 将尝试获取给定域的所有 DNS 记录，并发现任何子域及其相应的 IP 地址。该工具可能需要一些时间来完成其审讯，因为它对目标域实施了深入分析。

我们现在已经完成了本节的练习。接下来，我们将直接与目标进行接触，使用各种扫描技术收集更具体的细节。

# 扫描

让我们将信息收集阶段推进一步。在本节中，我们将对目标执行各种扫描类型。这些将包括以下内容：

+   Ping 扫描

+   操作系统和服务版本检测

+   扫描禁用 ICMP 的主机设备

+   执行隐蔽扫描

+   使用 Nmap 扫描 UDP 端口

+   使用 Nmap 执行规避扫描技术

扫描的目标是识别网络上的活动主机，确定系统上的开放和关闭端口，识别目标上运行的服务，并创建目标网络基础设施的网络图。在网络扫描阶段获取的信息对于创建目标组织的概况至关重要。

在许多国家，未经许可进行目标扫描是非法的。因此，我们将在我们的实验室内扫描设备。

在数据包中，有许多类型的 TCP 标志在网络上的两个或多个主机之间进行通信时使用。作为渗透测试人员，我们可以利用 TCP/IP 堆栈中的某些漏洞来执行网络扫描。换句话说，我们将向目标发送特制的标志，以确定其端口状态、操作系统、正在运行的服务及其版本；我们还将确定防火墙是否监视入站或出站流量等。

以下 TCP 标志位于数据包中：

+   `URG`：（**紧急**）指示应立即处理此数据包

+   `PSH`：（**推送**）立即发送缓冲数据

+   `FIN`：（**结束**）指示没有更多的传输需要发送

+   `ACK`：（**确认**）确认收到消息

+   `RST`：（**重置**）重置网络连接

+   `SYN`：（**同步**）用于初始化主机设备之间的连接

通过使用 Wireshark（[www.wireshark.org](http://www.wireshark.org)）等工具，您可以观察网络上数据包的每个细节。

以下片段是设置了`ACK`标志的网络数据包的捕获：

![](img/c5cb2d83-88ca-4217-aa77-c2a4ba04b59c.png)

启用 ACK 标志的数据包

此外，通过观察数据包中的细节，您可以看到源和目的地 MAC 地址、IP 地址、端口和其他重要特征。Wireshark 被认为是网络和网络安全专业人员中最好的网络协议分析器和嗅探器之一。

既然我们了解了扫描的重要性，让我们了解一下行业中最流行的扫描工具之一，Nmap。

# Nmap

Nmap 是免费的，是 Windows 和 Linux 平台上最强大的网络扫描工具之一。Nmap 可以在许多方面帮助网络管理员和网络安全专业人员。

Nmap 的功能包括以下内容：

+   创建网络清单

+   检查活动主机

+   确定操作系统

+   确定运行的服务及其版本

+   识别主机上的漏洞

+   检测嗅探器

+   确定网络上是否存在防火墙

我们将首先介绍 Nmap 的基础知识，然后逐渐转向高级扫描技术。作为渗透测试人员，我们必须确保拥有一套工具，可以帮助我们高效地完成工作。然而，作为专业人士，我们还必须确保非常熟悉并知道如何使用我们可用的每个工具。

因此，我们将从对目标进行基本扫描开始：

1.  让我们从打开一个新的终端并使用以下语法开始：`nmap <目标 IP 或主机名>`。

1.  我们将扫描一个已经给予我们合法许可的网站。让我们使用`nmap scanme.nmap.org`命令：

![](img/73168080-b963-4a51-9621-5977998d41ce.png)

Nmap 扫描 1

通过定期扫描目标或网络，Nmap 会检查目标上使用最广泛的 1000 个 TCP/IP 端口。

1.  观察输出，Nmap 能够识别开放的端口，确定开放的端口是 TCP 还是 UDP，识别应用层协议，并找出目标的 IP 地址（IPv4 和 IPv6）。

确定目标上的开放端口就像发现系统中的开放门一样，确定服务可以帮助我们缩小搜索和利用漏洞的范围。

要对 IPv6 地址进行扫描，可以包括`-6`操作符，如：`nmap -6 2600:3c01::f03c:91ff:fel8:bb2f`。

Nmap 并不那么难，对吧？让我们在接下来的部分中更深入地了解 Nmap。

# 使用 Nmap 进行 ping 扫描

有时，在渗透测试期间，您可能需要识别网络上的所有活动主机。Nmap 能够在多个目标上执行 ping 扫描，无论是指定范围还是整个子网。使用`-sn`操作符将允许您仅对目标执行 ping 扫描：

![](img/3266d5e1-d6ed-4c09-9512-3859e5c59b7a.png)

使用 Nmap 进行 ping 扫描

在前面的片段中，Nmap 只呈现了它认为在网络段上是活动的主机，并且能够查找每个主机的 MAC 地址以确定供应商。

+   如果您想要执行范围扫描，可以使用以下语法：`nmap start ip addr - end ip addr`。

+   如果您想要扫描网络上的特定 IP 设备，请使用以下语法：`nmap host1 host2 host3`。

+   Nmap 还支持使用以下语法扫描列在文本文件中的主机：`nmap –iL file.txt`。

现在让我们提升一下，学习更多关于如何在接下来的部分中使用 Nmap 的知识。

# 使用 Nmap 获取操作系统和服务版本

到目前为止，我们已经能够收集有关目标的基本信息。我们可以使用 Nmap 帮助用户确定操作系统、操作系统版本以及目标上运行的应用程序的服务版本。

使用`-A`操作符将启动一个侵略性扫描，`-O`将对操作系统进行概要分析，`-sV`将识别服务版本。

执行一种侵入式扫描可能会被**侵入检测系统**/**侵入预防系统**（**IDS**/**IPS**）或防火墙设备标记。要小心，因为渗透测试的一个重要部分是尽可能保持安静，以避免被发现。

在我们的目标系统 Metasploitable VM 上使用`nmap -A -O -sV target`命令，我们将能够获得关于目标的更有意义的信息。

正如您在以下片段中所看到的，对于每个开放的端口，Nmap 已经确定了在该端口上运行的特定服务，并且我们还能够检索应用服务版本的详细信息：

![](img/7ef78224-85f8-43ca-a260-b12cb5d06f53.png)

操作系统和服务版本

在输出中再向下滚动一点，我们可以看到，通过使用`-O`参数，Nmap 能够确定操作系统的类型：

![](img/adc54871-b19e-4032-9e42-a7ded6b2f17a.png)

检测内核版本

到目前为止，我们对我们的目标 Metasploitable VM 有了更好的了解。我们知道所有开放的端口、服务和当前正在运行的服务版本，以及操作系统。

Nmap 很棒，不是吗？让我们学习如何使用 Nmap 扫描禁用了 ICMP 的设备。

# 扫描禁用 ICMP 的主机设备

当 Nmap 要对主机执行扫描时，它会向主机发送一个 ping 数据包来确定目标是否存活。如果目标不响应，Nmap 将不会尝试执行扫描。然而，系统管理和网络安全专业人员通常会在服务器上禁用**Internet 控制消息协议**（**ICMP**）响应。从目标那里收不到 ICMP 回显回复将表明目标设备已关闭/离线；然而，这种技术旨在基本上欺骗一个新手黑客，让他认为主机根本不可用。在 Nmap 扫描期间使用`-Pn`操作符将跳过主机发现阶段，并将目标视为在线。

以下是一个例子：

```
nmap -Pn 10.10.10.100
```

在渗透测试期间，如果您无法在网络上发现活动主机，不要过分担心，因为网络安全专业人员倾向于在其终端设备和网络上应用安全控制。Nmap 可以检测隐藏的系统，绕过防火墙和网络嗅探器，以检测主机上的安全漏洞。

在执行扫描时，目标很可能会知道正在进行端口扫描的是攻击者还是渗透测试人员。在接下来的部分中，我们将描述如何使用 Nmap 执行隐秘扫描。

# 使用 Nmap 执行隐秘扫描

默认情况下，Nmap 会在找到的任何开放的 TCP 端口上建立**TCP 三次握手**。握手建立后，消息被交换。以下片段显示了握手过程，其中**主机 A**想要与**主机 B**通信：

![](img/c7b26f71-e515-4559-9794-452593e8cb45.png)

TCP 三次握手

在渗透测试期间，我们需要尽可能保持在网络上隐秘。这会产生一个实际黑客试图在不被组织的安全控制和系统发现的情况下入侵系统/网络的效果。通过与我们的目标设备建立 TCP 三次握手，我们让自己对目标设备有所了解。

因此，我们将使用 Nmap 执行隐秘扫描（半开放）。隐秘扫描不会与目标建立完整的 TCP 握手。

1.  攻击者机器通过向目标发送 TCP SYN 数据包来欺骗目标，如果目标上的特定端口是开放的。

1.  一个 TCP SYN/ACK 数据包被返回给攻击者机器。

1.  最后，攻击者发送一个 TCP RST 数据包来重置目标上的连接状态：

![](img/d9da960d-f408-47cd-89c3-9b88b7b14e47.png)

隐秘扫描

在我们的练习中，我们将使用 Nmap 对我们的 Metasploitable VM 上的端口`80`进行隐蔽扫描。使用`-sS`操作符表示隐蔽扫描，并使用`-p`操作符扫描（探测）特定端口，我们可以在我们的 Kali Linux 机器上执行`nmap -sS -p 80 10.10.10.100`命令：

![](img/aac02726-20c1-4e0a-8390-41e3079f4d34.png)

使用 Nmap 进行隐蔽扫描

使用 Wireshark，我们能够看到我们的 Kali Linux 机器和目标之间的数据包流动。数据包编号 18 表明一个[SYN]数据包被发送到 Metasploitable VM，数据包编号 19 表明一个[SYN, ACK]数据包被返回到 Kali Linux 机器，最后，数据包编号 20 表明我们的 Kali Linux 机器发送了一个[RST]数据包来重置连接：

![](img/be8c86d0-df1a-4b30-bd7d-42f5b4699fee.png)

在 Wireshark 中检测到隐蔽扫描

最终结果是我们成功地探测了目标系统上的一个端口，并没有在我们的机器和目标之间建立网络会话。

有许多服务和协议使用 UDP 作为首选的传输方法。UDP 应用默认不会响应典型的端口扫描。每当使用 Nmap 执行网络/端口扫描时，默认情况下扫描引擎会搜索开放的 TCP 端口；这意味着 UDP 端口通常在结果中被忽略。在下一节中，我们将看一下如何执行 UDP 端口扫描。

# 使用 Nmap 扫描 UDP 端口

有许多应用层协议使用**用户数据报协议**（**UDP**）作为其首选传输协议。使用`-sU`操作符将指示需要对给定目标执行 UDP 端口扫描。使用以下命令，我们可以完成这个任务：

```
nmap -sU target
```

我们现在已经掌握了在目标设备或网络上执行 UDP 扫描的技能。在下一节中，我们将看一下如何使用 Nmap 规避安全设备和检测。

# 使用 Nmap 规避检测

每当一个数据包从一个设备发送到另一个设备时，源 IP 地址都包含在数据包的头部。这是 TCP/IP 协议栈的默认行为；所有地址细节必须包含在需要穿越网络的所有数据包中。在对目标进行网络扫描时，我们的源 IP 地址包含在我们的机器 Kali Linux 发送到目标的所有数据包中。

Nmap 有能力使用伪装来欺骗目标，使其相信网络扫描是来自多个源而不是单个源 IP 地址。`-D`操作符后面跟着随机 IP 地址，这些是伪装。假设我们想要扫描一个 IP 地址`10.10.10.100`，并设置三个伪装：`10.10.10.14`、`10.10.10.15`和`10.10.10.19`。我们可以使用以下命令：

```
nmap -sS 10.10.10.100 –D 10.10.10.14, 10.10.10.15, 10.10.10.19
```

观察以下 Wireshark 捕获，我们可以看到在目标上进行端口扫描时，包含我们源 IP 地址和伪装 IP 地址的数据包被使用：

![](img/80c22611-9926-4be5-9550-9ec75d43947f.png)

在 Wireshark 中检测伪装

然而，一个 RST 数据包是从实际的源地址发送的。此外，我们还可以使用其他操作符，如`--spoof-mac`来伪装源 MAC 地址。

在下一节中，我们将学习如何在使用 Nmap 执行网络扫描时规避防火墙检测。

# 使用 Nmap 规避防火墙

在您作为网络安全专业人士、渗透测试人员或道德黑客的职业生涯中，您经常会遇到一些组织——无论是小型、中型还是大型企业——在其网络基础设施上都有某种防火墙设备或软件。

防火墙可以阻止网络扫描并给我们作为渗透测试人员带来挑战。以下是可以在 Nmap 中使用的各种操作符来规避防火墙：

![](img/ac7a1430-aad4-41b8-a51e-d0d5d19dc849.png)

Nmap 的防火墙规避操作符

此外，我们可以发送带有特定标志的自定义探测到目标并分析响应。

在接下来的部分中，我们将看看如何确定网络上是否存在有状态防火墙。

# 检查有状态防火墙

在检查有状态防火墙时，我们可以向目标发送一个启用了 ACK 标志的探测。 如果目标没有提供响应，这将表明存在防火墙：

![](img/9746582b-7a7c-493b-9bc2-b12d74b70367.png)

有状态防火墙存在

但是，如果返回的数据包设置了 RST 标志，这将表明目标系统上没有防火墙：

![](img/85436ee2-05c1-4737-b0aa-d379b7824871.png)

防火墙状态不明

我们可以使用 Nmap 上的`–sA`运算符对目标执行 ACK 扫描。 让我们对我们的 Metasploitable VM 执行扫描，以确定端口`80`是否打开，以及系统是否存在防火墙：

1.  使用`nmap -sA -p 80 <target>`命令：

![](img/f8b7d739-aa20-4443-a031-71981f137e48.png)

使用 Nmap 进行 ACK 扫描

1.  我们能够确定端口`80`在目标上是打开且未经过滤（没有防火墙）。 此外，通过观察数据包，我们看到 RST 数据包返回到我们的 Kali Linux（攻击者）机器：

![](img/1f287ce9-f845-48ec-9d42-8381cc64e60f.png)

Wireshark 中显示的端口扫描

每当您对目标进行扫描并且结果表明`filtered`时，这意味着存在防火墙，并且它正在积极监视端口，如下图所示：

![](img/8fa76c5f-be8b-4b82-af3a-a2d2b3287f13.png)

使用 Nmap 检测过滤端口

此外，以下运算符可用于确定系统上是否存在防火墙：

| **运算符** | **描述** |
| --- | --- |
| `-sX` | 执行 XMAS 扫描。 URG，FIN 和 PSH 标志都已设置。 |
| `-sF` | 执行 FIN 扫描。 仅设置 FIN 标志。 |
| `-sN` | 执行 Null 扫描。 没有设置标志。 |

额外的 Nmap 运算符

Nmap 将解释响应并确定目标上的端口是否经过过滤或未经过过滤。

完成了本节后，您现在可以使用 Nmap 对目标进行分析。 在下一节中，我们将学习**Nmap 脚本引擎**（**NSE**）。

# NSE 脚本

NSE 是 Nmap 中最强大的功能之一。 它允许用户创建和自动化脚本，以执行针对目标设备的定制扫描。 通过使用各种 Nmap 脚本执行扫描，您可以快速检测目标是否容易受到已知漏洞，恶意软件，开放后门等的攻击。

以下是 NSE 脚本的主要类别：

![](img/72161386-df94-4f48-8eb8-e2179bd803a6.png)

NSE 类别

要执行整个脚本类别，我们可以使用`--script category`命令。 以下代码片段是在 Nmap 扫描期间使用`vuln`脚本类别的示例：

![](img/9175a49e-9f88-4e4c-a09d-e07e9163b187.png)

使用 NSE 找到的漏洞

运行整个脚本类别可能并不总是适用于各种情况。 如果您正在执行扫描以搜索包含特定漏洞的系统，例如**vsFTPd 2.3.4 后门（CVE-2011-2523）**，您可以使用以下命令：

```
nmap --script ftp-proftpd-backdoor target
```

每个 NSE 脚本都存储在 Kali Linux 的`/usr/share/nmap/scripts`目录中。 但是，您应该熟悉使用 NSE 脚本，因为这将帮助您节省时间，并更快地找到有关目标的特定信息。 为了帮助您进一步了解 NSE 脚本，请访问官方 NSE 文档网站[`nmap.org/nsedoc/`](https://nmap.org/nsedoc/)。 该存储库包含每个 NSE 脚本的详细描述。

完成了关于 Nmap 和 NSE 的本节，现在让我们学习 Nmap 的 GUI 版本 Zenmap。

# Zenmap

Zenmap 是 Nmap 的图形用户界面（GUI）版本，并支持多个平台，如 Windows、Linux 和 macOS。Zenmap 的创建是面向初学者的，因为它比 Nmap 的传统命令行界面更容易使用。要在您的系统上下载 Zenmap，请访问[`nmap.org/zenmap/`](https://nmap.org/zenmap/)。

以下显示了 Zenmap 界面。它非常简单易用：只需输入目标并选择要执行的扫描类型。根据您选择的扫描类型，将在命令字段中设置必要的 Nmap 操作符。

为了演示，让我们通过观察以下步骤在我们的 Metasploitable VM 上进行快速扫描：

1.  输入我们目标的 IP 地址。

1.  从配置文件菜单中选择快速扫描选项。

1.  单击扫描开始，如下图所示：

![](img/19b1db05-aac6-41c9-bc1b-3ce37048de50.png)

Zenmap 界面

扫描完成后，单击每个选项卡以获取有关目标的更多详细信息。如果您正在对整个网络进行扫描，拓扑选项卡将帮助您创建目标网络的网络图。

可以通过以下步骤在 Zenmap 上创建自定义扫描配置文件：

1.  要创建新的扫描配置文件，请单击配置文件|新配置文件或命令。

1.  配置文件编辑器将打开，为您提供 Nmap 扫描的所有选项，如下图所示：

![](img/dacd1ddd-3956-44d8-8600-8e0b1f36d278.png)

Zenmap 配置文件编辑器

一定要访问每个选项卡，并熟悉各种可用的选项，因为它们将在将来有用。

正如您所看到的，Zenmap 非常易于使用和用户友好。在下一节中，我们将学习另一个工具 Hping3，用它来执行扫描。

# Hping3

Hping3 是一个命令行工具，允许用户分析网络上的 TCP/IP 消息。此外，Hping3 允许我们组装网络数据包，这对于渗透测试人员在执行设备和服务发现以及攻击性行动（如拒绝服务攻击）时可能有益。

Hping3 是一个可以执行以下任务的工具：

+   在网络上进行主机发现

+   指纹识别主机设备以确定服务

+   嗅探网络流量

+   洪水包（DoS）

+   文件传输

如前一节所述，有许多服务器和设备禁用了 ICMP 响应作为安全预防措施。我们可以使用 Hping3 来探测目标系统上的一个端口，以强制 ICMP 响应返回到我们的攻击者机器。

要开始使用 Hping3，让我们使用以下步骤在端口`80`上执行端口扫描：

1.  我们使用`ping`实用程序向我们的 Windows 服务器机器（启用防火墙并禁用 ICMP）发送四个 ICMP 回显请求消息：

![](img/91d4a945-3d52-4322-a7c9-09c74daa1b52.png)

对目标进行 ping

1.  我们的攻击者机器（Kali Linux）没有从目标那里收到任何响应。一个新手黑客可能会认为目标已离线，并可能会离开。但是，使用 Hping3 来探测特定端口，发送 SYN 数据包将迫使目标显露自己。使用`hping3 -S 目标 ip 地址 -p 端口 -c 2`语法，我们得到以下响应：

![](img/9f70b9a5-1094-4f99-af14-7b38b8b7904a.png)

使用 Hping3 进行端口扫描

通过查看我们的结果，我们可以看到我们已经从目标那里收到了成功的响应。这意味着`10.10.10.14`设备在线，并且端口`80`是开放的。

`-S`操作符表示发送 SYN 数据包，`-p`允许您指定目标端口号，`-c`指定要发送的数据包数量。

1.  此外，我们可以进一步采取一步行动，通过在目标设备上的一系列网络端口上执行端口扫描。使用`hping3 -8 20-1000 -S 10.10.10.14`命令，我们能够在目标上的端口范围`20`-`1000`上执行 SYN 扫描。以下片段表明我们的目标上的端口`80`、`135`、`139`、`445`、`902`和`912`是开放的：

![](img/d0a189ae-a036-46ba-b258-c401f5ecb998.png)

使用 Hping3 进行隐形扫描

在使用 Hping3 时，还有许多可以组合的操作符；请务必使用终端上的`hping3 -h`命令查看帮助菜单。

现在您已经熟悉了使用 Hping3 作为扫描器，让我们深入研究在目标设备上执行枚举。

# SMB、LDAP 枚举和空会话

在本节中，我们将研究使用各种应用程序协议来帮助我们从目标系统中提取敏感数据和记录。

# SMBmap 和 SMBclient

**SMBmap**是一个流行且易于使用的工具，用于帮助我们发现设备上的任何 SMB 共享并检测任何发现的共享的权限：

1.  使用`smbmap -H target`语法，我们可以尝试执行端口扫描，寻找 SMB 服务使用的端口；在我们的目标上，它是`445`，并且是开放的：

![](img/481ba446-50dd-486d-bbbf-d484989bb080.png)

SMB 共享

1.  SMBmap 将尝试在攻击者机器和目标端口`445`之间建立会话，以枚举任何共享驱动器和文件夹。在我们的目标（Metasploitable）上，有一个`tmp`文件夹，它给予我们读写权限。

1.  使用`smbmap -H 10.10.10.100 -r tmp`命令，我们将能够列出指定目录的内容。在我们的示例中，我们正在列出`tmp`文件夹的内容，如下截图所示：

![](img/1a809591-326b-4b25-be51-cbe066e69961.png)

SMBmap 枚举

SMBmap 是一个枚举目标设备上 SMB 共享的绝佳工具；然而，始终最好在您的工具库中有另一个工具可用。其他工具包括 SMBlookup、SMBclient 和 Nmap。

有关 SMBmap 的更多信息，请访问：[`tools.kali.org/information-gathering/smbmap`](https://tools.kali.org/information-gathering/smbmap)。

**SMBclient**是另一个方便的工具，工作方式类似于 SMBmap。要在目标上枚举 SMB 服务，我们可以使用`smbclient -L //target`命令：

![](img/2a63d131-89cd-4585-adac-f67b2512e8fe.png)

SMBclient 枚举

SMBclient 将尝试提取目标设备上的任何共享，如前面的截图所示。有关 SMBclient 的更多信息，请访问：[`www.samba.org/samba/docs/current/man-html/smbclient.1.html`](https://www.samba.org/samba/docs/current/man-html/smbclient.1.html)。

完成了本节后，您已经掌握了使用 SMBmap 和 SMBclient 在目标上执行 SMB 枚举的技能。在下一节中，我们将简要讨论另一个流行的 SMB 枚举工具 Enum4linux。

# Enum4linux

**Enum4linux**是一种枚举工具，能够检测和提取 Windows 和 Linux 操作系统上的数据，包括网络上的**Samba**（**SMB**）主机。Enum4linux 能够发现以下内容：

+   目标上的密码策略

+   远程目标的操作系统

+   设备上的共享（驱动器和文件夹）

+   域和组成员资格

+   用户列表

要扫描目标，请使用以下命令：`enum4linux target`。该工具将执行所有可能的检查和枚举。一开始输出可能有点压倒性：一定要仔细检查细节，因为它们将包含有关目标的有意义信息。

Enum4linux 有时会派上用场，用于在网络上执行扫描以发现任何共享资源。在下一节中，我们将深入探讨 Windows 网络上的 LDAP 枚举。

# LDAP 枚举

**轻量级目录访问协议**（**LDAP**）用于查询数据库或目录类型的服务。一个常见的例子是一个拥有**Active Directory**（**AD**）服务器的企业环境，该服务器管理整个组织的用户账户。诸如台式电脑之类的终端设备需要在每次用户尝试登录到该台式电脑时查询 AD 服务器。

LDAP 默认使用端口`389`；然而，数据包以明文形式在网络上传输。另外，使用**LDAPS**（**LDAP 安全**）确保了在客户端和 LDAP 服务器之间发送的信息默认是加密的；LDAPS 默认使用端口`636`。我们可以使用 Nmap 扫描在网络上具有端口`389`和`636`开放的设备。

我们可以使用一个名为 JXplorer（[`jxplorer.org`](http://jxplorer.org)）的工具来执行 LDAP 枚举。这个工具不是在 Kali Linux 中原生安装的，因此，我们需要从它的 GitHub 存储库中下载并运行它。

要开始 LDAP 枚举，让我们使用以下步骤： 

1.  使用以下命令来下载和执行这个工具：

```
git clone https://github.com/pegacat/jxplorer.git cd jxplorer chmod +x jxplorer.sh ./jxplorer.sh
```

1.  一旦成功执行`./jxplorer.sh`脚本，用户界面将会打开。点击连接图标（位于文件下方）来插入你的目标的详细信息：

![](img/207f67b3-e9fd-4e47-a5a7-b0f7f5b23047.png)

JXplorer 界面

在我们的实验室中，我们有一台 Windows Server 机器，配置如下：

+   已安装 Active Directory 域服务

+   已安装 Active Directory 轻量级目录服务

+   域：`pentestlab.local`

+   创建的用户账户：`bob`（属于域管理员用户组）

假设，在渗透测试期间，通过使用数据包嗅探工具如 Wireshark，你能够在用户尝试对 AD 服务器进行身份验证时捕获用户凭据，你可以在前面的截图中的安全字段中使用这些用户账户。

使用管理员用户账户将提供在 JXplorer 中提取信息所需的权限；你将能够从 Active Directory 服务器中枚举敏感信息，如下图所示：

![](img/e7b8c7b8-0bf1-4981-bd94-70102e37d663.png)

使用 JXplorer 进行 LDAP 枚举

你将能够从你的攻击者机器上查看整个目录并提取敏感信息。如果服务只使用 LDAPS，这将是一个挑战，因为用户凭据将被隐藏。

完成了这个练习之后，让我们在下一节中使用**rpcclient**工具执行一个空会话攻击。

# 空会话

在一个空会话中，攻击者能够使用一个空账户登录到目标。空账户是一个实际上并不存在的账户。这是怎么可能的呢？一些系统容易受到允许匿名登录的漏洞。一旦用户能够匿名登录，空用户就能够检索存储在目标上的敏感信息。

我们可以尝试从我们的 Kali Linux 机器（攻击者）到目标 Metasploitable 上进行一个空会话枚举，使用`rpcclient -U "" 10.10.10.100`命令，如下图所示：

![](img/39cd647e-81c9-4cca-bbe8-f78fa963c091.png)

空会话攻击

使用`srvinfo`命令，目标将会向我们返回它的操作系统类型。要获取查询命令的完整列表，你可以使用`rpcclient --help`命令。另外，你可以访问[`www.samba.org/samba/docs/current/man-html/rpcclient.1.html`](https://www.samba.org/samba/docs/current/man-html/rpcclient.1.html)。

请记住，并非所有的机器都容易受到这种类型的攻击，但在渗透测试中执行这种攻击仍然是值得的。在下一节中，我们将讨论通过嘈杂的身份验证控制进行用户枚举。

# 通过嘈杂的身份验证控制进行用户枚举

枚举是黑客或渗透测试人员尝试对目标系统执行暴力攻击以猜测或确认有效用户的技术。一个简单的例子是，恶意用户或渗透测试人员在电子邮件门户上执行密码猜测或暴力攻击。

以下是一个典型登录门户的示例。以下截图中显示的凭据是一个示例，不是真实的：

![](img/5860f2b0-7691-426d-b5f3-d7ee75d908af.png)

攻击者可以尝试各种可能的用户名和密码组合，直到找到一个有效的用户。然而，这种攻击被认为是喧闹的而不是隐秘的。作为比较，想象一下你在玩一个在线第一人称射击游戏，你的任务是入侵敌人的基地并偷走一个奖杯而不引起警卫的注意。如果你不够小心并发出任何大声的声音，警卫就会被警觉，任务就会失败。在这个类比中，警卫是安全控制，传感器是防火墙、IDS/IPS 和反恶意软件保护。因此，这种技术在网络上并不是安静的；然而，这种方法仍然可以让你访问系统，前提是安全控制在你获得访问权限之前不执行锁定操作。

很多时候，当用户在登录门户上输入错误的用户名时，通常会返回一个错误消息，通常说明已输入了错误的用户名。这清楚地告诉攻击者，提供的用户名在数据库中不存在。此外，如果输入了错误的密码，系统通常会返回一条消息，说明为该用户名输入了错误的密码。因此，从攻击者的角度来看，系统告诉我们，用户名存在于数据库中，但我们没有为它提供正确的密码。

现在，Web 开发人员和安全专业人员在用户名或密码不正确时都包含了通用响应，类似于这样的消息：*用户名/密码不正确*。这条消息并没有明确说明哪个值是正确的或不正确的。

现在您对喧闹的身份验证控件有了更好的理解，让我们尝试在下一节中执行 Web 枚举。

# 使用 EyeWitness 进行 Web 足迹和枚举

**EyeWitness**是一个允许渗透测试人员在不离开终端的情况下捕获网站截图的工具——该工具在后台完成所有工作。想象一下需要对多个网站进行视觉配置文件、打开**虚拟网络计算**（**VNC**）服务器和使用**远程桌面协议**（**RDPs**）的情况。这可能是一个耗时的任务。EyeWitness 拍摄截图，将它们存储在离线状态，并提供 HTML 报告：

1.  首先，您需要使用`git clone https://github.com/FortyNorthSecurity/EyeWitness.git`从其 GitHub 存储库下载 EyeWitness。

1.  下载完成后，访问`root/EyeWitness/setup`目录，并使用以下命令序列运行`setup.sh`脚本：

![](img/12d98d7c-a8ae-45c8-97b2-8eaf1f551d31.png)

EyeWitness 设置屏幕

1.  设置过程完成后，使用`cd ..`命令进入`root/EyeWitness`目录。要对单个网站进行截图，使用以下命令：

```
./EyeWitness.py --web --single example.com 
```

您可以在 Metasploitable 或 OWASP BWA 虚拟机上的一个 Web 应用程序上尝试这个工具。

EyeWitness 允许您使用`--web`、`--rdp`、`--vnc`和`--all-protocols`等操作符指定各种协议。

1.  任务完成后，EyeWitness 将指示是否成功捕获了目标的截图，并为您提供离线报告的位置，如下图所示：

![](img/46f904e0-5e3b-4dd1-a605-0eea354e98d2.png)

EyeWitness 报告向导

1.  打开 HTML 报告后，左侧列包含有关 Web 请求的信息，而右侧列包含截图：

![](img/7f541fd7-bdcc-45e5-a921-1bc05a3dd3e0.png)

EyeWitness 的报告

这个工具在同时对多个服务和网站进行概要分析时非常方便。

有关 EyeWitness 的更多信息，请访问[`tools.kali.org/information-gathering/eyewitness`](https://tools.kali.org/information-gathering/eyewitness)。

现在您已经完成了这一部分，可以使用 EyeWitness 工具执行 Web 枚举。

# Metasploit 辅助模块

Metasploit 是由 Rapid7 创建的开发利用框架（[www.rapid7.com](http://www.rapid7.com)）。Metasploit 包含许多用于渗透测试的功能和功能。有许多模块，如 exploits、payloads、encoders 和 auxiliary。辅助模块包含端口扫描器、网络嗅探器、模糊器等，以便于渗透测试的信息收集阶段：

1.  要访问 Metasploit 界面，请打开一个新的终端并执行以下命令：

```
service postgresql start msfconsole
```

1.  一旦用户界面加载，`show auxiliary`命令将提供 Metasploit 中所有辅助模块的列表。让我们用一个简单的例子来演示如何使用模块：假设您想对目标进行隐秘（SYN）扫描。您可以开始选择一个模块。

1.  使用`use auxiliary/scanner/portscan/syn`命令。

1.  使用`show options`命令检查描述和要求。

1.  此模块要求配置远程主机；使用`set RHOSTS target`命令。

1.  要执行模块，请使用`run`命令。

1.  以下截图演示了对我们的 Windows 服务器（`10.10.10.14`）进行隐秘扫描的结果底部显示了找到的各种开放端口：

![](img/71c7c9fa-34f1-49f2-8355-67fdcef8df66.png)

1.  此外，在 Metasploit 中搜索模块时，使用`search keyword`语法非常有用，因为框架中有许多不同的模块，学习它们都可能非常具有挑战性和压倒性。

在本书的后续章节中，我们将深入探讨如何使用 Metasploit 在我们的实验室中对目标设备进行利用。

# 摘要

在本章中，我们使用了各种 DNS 询问技术，使用各种工具发现了重要的服务器、子域和 IP 地址，并成功地从 DNS 服务器（区域传输）中提取了区域文件，因为目标 DNS 服务器的配置错误。

然后，我们使用 Nmap 执行各种类型的端口扫描，以确定端口状态、运行服务及其版本以及目标操作系统；我们还得知了目标是否有防火墙。最后，为了结束本章，我们执行了 SMB 和 LDAP 枚举，以收集网络设备上的用户共享和目录记录。

现在您已经完成了本章，您将能够成功地在易受攻击的 DNS 服务器上执行 DNS 区域传输；对系统进行概要分析，发现其操作系统、运行服务和安全漏洞；在执行网络扫描时规避检测；并在目标上执行 LDAP 和系统枚举。您还获得了同时对多个网站进行视觉概要分析的技能。希望本章对您学习渗透测试的旅程有所帮助。

在第七章中，*使用漏洞扫描器*，我们将介绍使用漏洞扫描器查找目标上的安全漏洞和缺陷的重要性。

# 问题

以下是基于本章内容的一些问题：

1.  使用 DNS 的主要目的是什么？

1.  DNS 区域传输是什么意思？

1.  什么工具允许我们对目标系统进行扫描，并确定其运行的服务和操作系统？

1.  在扫描期间使用了什么方法来规避防火墙？

1.  可以用什么工具来枚举 Active Directory？

# 进一步阅读

+   信息收集和漏洞评估：[`hub.packtpub.com/information-gathering-and-vulnerability-assessment-0/`](https://hub.packtpub.com/information-gathering-and-vulnerability-assessment-0/)

+   开源情报：[`hub.packtpub.com/open-source-intelligence/`](https://hub.packtpub.com/open-source-intelligence/)

+   收集情报并制定攻击策略：[`hub.packtpub.com/gather-intel-and-plan-attack-strategies/`](https://hub.packtpub.com/gather-intel-and-plan-attack-strategies/)
